"use strict";var VClipboard={getTextArea:function(){var t=document.createElement("textarea");t.style.position="absolute";t.style.left="-99px";t.style.width="0";IsFirefox&&(t.contentEditable="true");this.getTextArea=function(){return t};return t},tailSpacesRe:/[ \t]+\n/g,format:function(t){var e=(t=t.replace(Utils.A0Re," ").replace(this.tailSpacesRe,"\n")).charCodeAt(t.length-1);32!==e&&9!==e||((e=t.lastIndexOf("\n")+1)?t=t.substring(0,e)+t.substring(e).trimRight():32!==(e=t.charCodeAt(0))&&9!==e&&(t=t.trimRight()));return t},copy:function(t){t=this.format(t);var e=this.getTextArea();e.value=t;document.documentElement.appendChild(e);e.select();document.execCommand("copy");e.remove();e.value="";Utils.resetRe()},paste:function(){if(!Settings.CONST.AllowClipboardRead)return null;var t=this.getTextArea();document.documentElement.appendChild(t);t.focus();document.execCommand("paste");var e=t.value;t.remove();t.value="";e=e.replace(Utils.A0Re," ");Utils.resetRe();return e}},ContentSettings={makeKey:function(t,e){return"vimiumContent|"+t+(e?"|"+e:"")},onRuntimeError:function(){return chrome.runtime.lastError},complain:function(t,e){if(!chrome.contentSettings){Backend.showHUD("This version of Vimium C has no permissions to set CSs");return true}if(!chrome.contentSettings[t]||/^[A-Z]/.test(t)){Backend.showHUD("Unknown content settings type: "+t);return true}if(Utils.protocolRe.test(e)&&!e.startsWith("chrome"))return false;Backend.complain("change its content settings");return true},parsePattern:function(t,e){if(t.startsWith("file:")){var n=56<=Settings.CONST.ChromeVersion?1:1<e?2:0;if(n){Backend.complain(1===n?"set file CSs since Chrome 56":"set CS of file folders");return[]}return[t.split(/[?#]/,1)[0]]}if(t.startsWith("ftp:")){Backend.complain("set FTP pages' content settings");return[]}var i=t.match(/^([^:]+:\/\/)([^\/]+)/),r=Utils.hostRe.exec(i[2]),s,o=r[3]+(r[4]||"");s=[(t=i[1])+o+"/*"];if(e<2||Utils.isIPHost(r[3],0))return s;r=null;for(var a=o.toLowerCase().split("."),l=a.length,c=0===Utils.isTld(a[l-1])?1:2<l&&2===a[l-1].length&&1===Utils.isTld(a[l-2])?3:2,u=Math.min(a.length-c,e-1),h=0;h<u;h++){o=o.substring(a[h].length+1);s.push(t+o+"/*")}s.push(t+"*."+o+"/*");u===a.length-c&&"http://"===t&&s.push("https://*."+o+"/*");return s},Clear:function(t,e){if(chrome.contentSettings){var n=chrome.contentSettings[t];if(n&&n.clear)if(e)n.clear({scope:e.incognito?"incognito_session_only":"regular"});else{n.clear({scope:"regular"});n.clear({scope:"incognito_session_only"},ContentSettings.onRuntimeError);localStorage.removeItem(ContentSettings.makeKey(t))}}},clearCS:function(t,e){var n=""+t.type;if(!this.complain(n,"https://a.cc/")){this.Clear(n,e.sender);return Backend.showHUD(n+" content settings have been cleared.")}},toggleCS:function(t,e,n){var i=""+e.type,r=n[0];return e.incognito?this.ensureIncognito(t,i,r):this.toggleCurrent(t,i,r,"reopen"===e.action)},toggleCurrent:function(e,n,i,r){var s=Utils.removeComposedScheme(i.url);ContentSettings.complain(n,s)||chrome.contentSettings[n].get({primaryUrl:s,incognito:i.incognito},function(t){ContentSettings.setAllLevels(n,s,e,{scope:i.incognito?"incognito_session_only":"regular",setting:t&&"allow"===t.setting?"block":"allow"},function(t){if(!t){if(!i.incognito){var e=ContentSettings.makeKey(n);"1"!==localStorage.getItem(e)&&localStorage.setItem(e,"1")}if(i.incognito||r){++i.index;return Backend.reopenTab(i)}if(0<i.index&&chrome.sessions)return Backend.reopenTab(i,true);chrome.windows.getCurrent({populate:true},function(t){t&&"normal"===t.type?Backend.reopenTab(i,1<t.tabs.length&&!!chrome.sessions):chrome.tabs.reload(ContentSettings.onRuntimeError);return chrome.runtime.lastError})}})})},ensureIncognito:function(r,s,o){if(Settings.CONST.DisallowIncognito)return Backend.complain("change incognito settings");var a=Utils.removeComposedScheme(o.url);ContentSettings.complain(s,a)||chrome.contentSettings[s].get({primaryUrl:a,incognito:true},function(i){if(chrome.runtime.lastError){chrome.contentSettings[s].get({primaryUrl:a},function(t){if(!t||"allow"!==t.setting){var e;chrome.windows.create({type:"normal",incognito:true,focused:false,url:"about:blank"},function(t){var e=t.tabs[0].id;return ContentSettings.setAndUpdate(r,s,o,a,t.id,true,function(){chrome.tabs.remove(e)})})}});return chrome.runtime.lastError}if(i&&"allow"===i.setting&&o.incognito)return ContentSettings.updateTab(o);chrome.windows.getAll(function(t){if((t=t.filter(function(t){return t.incognito&&"normal"===t.type})).length){if(i&&"allow"===i.setting)return ContentSettings.updateTab(o,t[t.length-1].id);var e=o.windowId,n=o.incognito&&t.some(function(t){return t.id===e});return ContentSettings.setAndUpdate(r,s,o,a,n?void 0:t[t.length-1].id)}console.log("%cContentSettings.ensure","color:red","get incognito content settings",i," but can not find an incognito window.")})})},setAndUpdate:function(t,e,n,i,r,s,o){var a=ContentSettings.updateTabAndWindow.bind(null,n,r,o);return ContentSettings.setAllLevels(e,i,t,{scope:"incognito_session_only",setting:"allow"},s&&r!==n.windowId?function(t){if(t)return a(t);chrome.windows.get(n.windowId,a)}:a)},setAllLevels:function(t,e,n,i,r){var s,o=false,a=chrome.contentSettings[t],l=function(){var t=chrome.runtime.lastError;t&&console.log("[%o]",Date.now(),t);if(o)return t;--s;((o=!!t)||0===s)&&setTimeout(r,0,o);return t},c=ContentSettings.parsePattern(e,0|n);if((s=c.length)<=0)return r(true);Object.setPrototypeOf(i,null);for(var u=0,h=c;u<h.length;u++){var f=h[u],g=Utils.extendIf(Object.create(null),i);g.primaryPattern=f;a.set(g,l)}},updateTabAndWindow:function(t,e,n,i){true!==i&&ContentSettings.updateTab(t,e);n&&n();true!==i&&e&&chrome.windows.update(e,{focused:true,state:i?i.state:void 0})},updateTab:function(t,e){t.active=true;if("number"!=typeof e||t.windowId===e)++t.index;else{t.index=void 0;t.windowId=e}Backend.reopenTab(t)}},Marks={cache:localStorage,cacheI:null,_storage:function(){var t=Object.create(null);t.setItem=function(t,e){this[t]=e};return t},_set:function(t,e,n){var i=t.local,r=t.markName,s=t.url,o=t.scroll,a=e?this.cacheI||(IncognitoWatcher.watch(),this.cacheI=this._storage()):this.cache;if(i&&0===o[0]&&0===o[1])if(2===o.length){var l=s.indexOf("#");0<l&&l<s.length-1&&o.push(s.substring(l))}else(o[2]||"").length<2&&o.pop();a.setItem(this.getLocationKey(r,i?s:""),JSON.stringify(i?o:{tabId:n,url:s,scroll:o}))},_goto:function(t,e){t.postMessage({name:"execute",command:"Marks.goTo",count:1,options:e,CSS:null})},createMark:function(t,e){var n=e.sender.tabId;if(t.scroll)return Marks._set(t,e.sender.incognito,n);(e=Backend.indexPorts(n,0)||e)&&e.postMessage({name:"createMark",markName:t.markName})},gotoMark:function(t,e){var n=t.local,i=t.markName,r=Marks.getLocationKey(i,n?t.url:""),s=Marks.cacheI&&e.sender.incognito&&Marks.cacheI[r]||Marks.cache.getItem(r);if(n){var o=s?JSON.parse(s):null;if(!o){var a=t.old,l=void 0,c=void 0;if(a&&0<=(l=+a.scrollX)&&0<=(c=+a.scrollY)){t.scroll=o=[l,c,a.hash];Marks._set(t,e.sender.incognito)}}if(o)return Marks._goto(e,{markName:i,scroll:o,local:true})}if(!s)return Backend.showHUD((n?"Local":"Global")+" mark not set : ' "+i+" '.");var u=JSON.parse(s);u.markName=i;u.prefix=false!==t.prefix&&0===u.scroll[1]&&0===u.scroll[0]&&!!Utils.IsURLHttp(u.url);if(!Backend.indexPorts(u.tabId))return Backend.focus(u);chrome.tabs.get(u.tabId,Marks.checkTab.bind(u))},checkTab:function(t){var e=t.url.split("#",1)[0];if(e===this.url||this.prefix&&this.url.startsWith(e)){Backend.gotoSession({sessionId:t.id});return Marks.scrollTab(this,t)}return Backend.focus(this)},getLocationKey:function(t,e){return(e?"vimiumMark|"+Utils.prepareReparsingPrefix(e.split("#",1)[0]):"vimiumGlobalMark")+"|"+t},scrollTab:function(t,e){var n=e.id,i=Backend.indexPorts(n,0);i&&Marks._goto(i,{markName:t.markName,scroll:t.scroll});if(t.tabId!==n&&t.markName)return Marks._set(t,1===TabRecency.incognito,n)},clear:function(t){for(var e=Marks.getLocationKey("",t),n=[],i=Marks.cache,r=0,s=i.length;r<s;r++){var o;(o=i.key(r)).startsWith(e)&&n.push(o)}for(var a=0,l=n;a<l.length;a++){var o;i.removeItem(o=l[a])}var c=n.length;if(Marks.cacheI){var u=Marks.cacheI;for(var o in u)if(o.startsWith(e)){c++;delete u[o]}}return Backend.showHUD(c+" "+(t?"local":"global")+" mark"+(1!==c?"s have":" has")+" been removed.")}},FindModeHistory={key:"findModeRawQueryList",max:50,list:null,listI:null,timer:0,init:function(){var t=Settings.get(this.key);this.list=t?t.split("\n"):[];this.init=null},query:function(t,e,n){this.init&&this.init();var i=t?this.listI||(IncognitoWatcher.watch(),this.listI=this.list.slice(0)):this.list;if(!e)return i[i.length-(n||1)]||"";if(t)return this.refreshIn(e,i,true);var r=this.refreshIn(e,i);r&&Settings.set(this.key,r);return this.listI?this.refreshIn(e,this.listI,true):void 0},refreshIn:function(t,e,n){var i=e.lastIndexOf(t);if(0<=i){if(i===e.length-1)return;e.splice(i,1)}else this.max<=e.length&&e.shift();e.push(t);if(!n)return e.join("\n")},removeAll:function(t){if(t)this.listI&&(this.listI=[]);else{this.init=null;this.list=[];Settings.set(this.key,"")}}},IncognitoWatcher={watching:false,timer:0,watch:function(){if(!this.watching){chrome.windows.onRemoved.addListener(this.OnWndRemvoed);this.watching=true}},OnWndRemvoed:function(){var t=IncognitoWatcher;IncognitoWatcher.watching&&(IncognitoWatcher.timer=IncognitoWatcher.timer||setTimeout(IncognitoWatcher.TestIncognitoWnd,34))},TestIncognitoWnd:function(){IncognitoWatcher.timer=0;if(52<=Settings.CONST.ChromeVersion){var t=false,e=Backend.indexPorts();for(var n in e)if(e[n][0].sender.incognito){t=true;break}if(t)return}chrome.windows.getAll(function(t){t.some(function(t){return t.incognito})||IncognitoWatcher.cleanI()})},cleanI:function(){Marks.cacheI=FindModeHistory.listI=null;chrome.windows.onRemoved.removeListener(this.OnWndRemvoed);this.watching=false}},TabRecency={tabs:Object.create(null),last:chrome.tabs.TAB_ID_NONE||-1,lastWnd:chrome.windows.WINDOW_ID_NONE||-1,incognito:0,rCompare:null};setTimeout(function(){function n(){var t=r;for(var e in t)t[e]<=896?delete t[e]:t[e]-=895;o=128}function i(t){var e=Date.now();if(500<e-a){r[TabRecency.last]=++o;1023===o&&n()}TabRecency.last=t.tabId;a=e}function e(t){if(!t)return chrome.runtime.lastError;var e=t[0];if(e){TabRecency.lastWnd=e.windowId;TabRecency.incognito=+e.incognito;return i({tabId:e.id})}}var r=TabRecency.tabs,s=chrome.windows.WINDOW_ID_NONE||-1,o=1,a=0;chrome.tabs.onActivated.addListener(i);chrome.windows.onFocusChanged.addListener(function(t){t!==s&&chrome.tabs.query({windowId:t,active:true},e)});chrome.tabs.query({currentWindow:true,active:true},function(t){a=Date.now();var e=t&&t[0];if(!e)return chrome.runtime.lastError;TabRecency.last=e.id;TabRecency.lastWnd=e.windowId;TabRecency.incognito=e.incognito?1:0});TabRecency.rCompare=function(t,e){return r[e.id]-r[t.id]};for(var t=0,l=["images","plugins","javascript","cookies"];t<l.length;t++){var c=l[t];null!=localStorage.getItem(ContentSettings.makeKey(c))&&setTimeout(ContentSettings.Clear,100,c)}},120);Backend.onInit();chrome.extension.isAllowedIncognitoAccess&&chrome.extension.isAllowedIncognitoAccess(function(t){var e;(Settings.CONST.DisallowIncognito=false===t)&&console.log("Sorry, but some commands of Vimium C need the permission to run in incognito mode.")});setTimeout(function(){var k=0,d=0,w=null,m=false,s=false,o=0,T=0,l=0,U=0,I=0,C=[""],p="",v="",Suggestion=function(t,e,n,i,r,s){this.type=t;this.url=e;this.text=n;this.title=i;this.relevancy=r(this,s)},R={prepareHtml:function(t){if(null==t.textSplit){t.title=this.cutTitle(t.title);var e=t.text,n=this.shortenUrl(e);t.text=e.length!==t.url.length?n:"";t.textSplit=this.cutUrl(n,this.getRanges(n),e.length-n.length,s?o-13-Math.min(t.title.length,40):o)}else t.text===t.url&&(t.text="")},cutTitle:function(t){var e=o+40<t.length;e&&(t=t.substring(0,o+39));return this.highlight(e?t+"\u2026":t,this.getRanges(t))},highlight:function(t,e){if(0===e.length)return Utils.escapeText(t);for(var n="",i=0,r=0;r<e.length;r+=2){var s=e[r],o=e[r+1];n+=Utils.escapeText(t.substring(i,s));n+="<match>";n+=Utils.escapeText(t.substring(s,o));n+="</match>";i=o}return n+Utils.escapeText(t.substring(i))},shortenUrl:function(t){var e=Utils.IsURLHttp(t);return!e||t.length<=e?t:t.substring(e,t.length-+(t.endsWith("/")&&!t.endsWith("://")))},getRanges:function(t){for(var e=[],n=0,i=C.length;n<i;n++)for(var r=0,s=0,o=void 0,a=t.split(b.parts[n]),l=a.length-1,c=C[n].length;r<l;r++,s=o){o=(s+=a[r].length)+c;e.push([s,o])}if(0===e.length)return e;if(1===e.length)return e[0];e.sort(this.sortBy0);for(var u=e[0],n=1,h=1,i=e.length;h<i;h++){var f=e[h];if(f[0]<=u[n])u[n]<f[1]&&(u[n]=f[1]);else{u.push(f[0],f[1]);n+=2}}return u},sortBy0:function(t,e){return t[0]-e[0]},cutUrl:function(t,e,n,i){var r="",s=t.length,o=s;s<=i||(1<n?o=t.indexOf("/")+1||s:(o=t.indexOf(":"))<0?o=s:Utils.protocolRe.test(t.substring(0,o+3).toLowerCase())?o=t.indexOf("/",o+4)+1||s:o+=22);if(o<s)for(var a=e.length,l=s+8;0<=(a-=2)&&o<=l;l=e[a]){var c=e[a+1],u;if(0<(u=l-20-Math.max(c,o))&&(s-=u)<=i){o=c+(i-s);break}}for(var a=s=0;s<i&&a<e.length;a+=2){var l=e[a],h=Math.max(s,o),u;if(0<(u=l-20-h)){i+=u;r+=Utils.escapeText(t.substring(s,h+11));r+="\u2026";r+=Utils.escapeText(t.substring(l-8,l))}else s<l&&(r+=Utils.escapeText(t.substring(s,l)));s=e[a+1];r+="<match>";r+=Utils.escapeText(t.substring(l,s));r+="</match>"}return t.length<=i?r+Utils.escapeText(t.substring(s)):r+Utils.escapeText(t.substring(s,s<i-1?i-1:s+10))+"\u2026"},ComputeWordRelevancy:function(t){return _.wordRelevancy(t.text,t.title)},ComputeRelevancy:function(t,e,n){var i=_.recencyScore(n),r=_.wordRelevancy(t,e);return i<=r?r:(r+i)/2}},O={bookmarks:{bookmarks:[],dirs:[],currentSearch:null,path:"",depth:0,status:0,filter:function(t,e){if(0===C.length){O.next([]);if(0!==e)return}else{if(2===this.status)return this.performSearch();this.currentSearch=t}if(0===this.status)return this.refresh()},StartsWithSlash:function(t){return 47===t.charCodeAt(0)},performSearch:function(){for(var t=C.some(this.StartsWithSlash),e=this.bookmarks,n=e.length,i=[],r=0;r<n;r++){var s,o;_.Match2((s=e[r]).text,t?s.path:s.title)&&i.push([-_.wordRelevancy(s.text,s.title),r])}U+=i.length;if(1===k||0===I){i.sort(R.sortBy0);if(0<I){i=i.slice(I,I+T);I=0}else T<i.length&&(i.length=T)}for(var a=0,l=function(){return a},c=[],u=0,h=i;u<h.length;u++){var r,s;a=-(r=h[u])[0];var f=new Suggestion("bookm",(s=e[r[1]]).url,s.text,t?s.path:s.title,l);c.push(f);if(null!==s.jsUrl){f.url=s.jsUrl;f.title=R.cutTitle(f.title);f.textSplit="javascript: \u2026";f.text=s.jsText}}return O.next(c)},Listen:function(){var t=chrome.bookmarks,e=O.bookmarks.Delay,n=O.bookmarks.Expire;if(t.onCreated){t.onCreated.addListener(e);t.onRemoved.addListener(n);t.onChanged.addListener(n);t.onMoved.addListener(e);t.onImportBegan.addListener(function(){chrome.bookmarks.onCreated.removeListener(O.bookmarks.Delay)});t.onImportEnded.addListener(function(){var t=O.bookmarks.Delay;chrome.bookmarks.onCreated.addListener(t);t()})}},refresh:function(){this.status=1;if(this._timer){clearTimeout(this._timer);this._timer=0}chrome.bookmarks.getTree(this.readTree.bind(this))},readTree:function(t){this.status=2;this.bookmarks=[];this.dirs=[];t.forEach(this.traverseBookmark,this);var e=this.currentSearch;this.currentSearch=null;setTimeout(function(){return L.decodeList(O.bookmarks.bookmarks)},50);if(this.Listen){setTimeout(this.Listen,0);this.Listen=null}if(e&&!e.isOff)return this.performSearch()},traverseBookmark:function(t){var e=t.title,n=t.id,i=this.path+"/"+(e||n);if(t.children){this.dirs.push(n);var r=this.path;2<++this.depth&&(this.path=i);t.children.forEach(this.traverseBookmark,this);--this.depth;this.path=r}else{var s=t.url,o="javascript:",a=s.startsWith(o);this.bookmarks.push({id:n,path:i,title:e,url:a?o:s,text:a?o:s,jsUrl:a?s:null,jsText:a?Utils.DecodeURLPart(s):null})}},_timer:0,_stamp:0,_expiredUrls:false,Later:function(){var t=O.bookmarks,e=Date.now()-t._stamp;if(0===t.status)if(6e4<=e||e<0){t._timer=t._stamp=0;t._expiredUrls=false;t.refresh()}else{t.bookmarks=[];t.dirs=[];t._timer=setTimeout(t.Later,3e4)}},Delay:function(){var t=O.bookmarks;t._stamp=Date.now();if(!(t.status<2)){t._timer=setTimeout(t.Later,6e4);t.status=0}},Expire:function(t,e){for(var n=O.bookmarks,i=n.bookmarks,r=i.length,s=e&&e.title,o=0;o<r&&i[o].id!==t;o++);if(o<r){var l=i[o],c=l.url,u=e&&e.url;L.enabled&&(null==s?c!==l.text||!e:null!=u&&c!==u)&&c in L.dict&&y.binarySearch(c)<0&&delete L.dict[c];if(null!=s){l.path=l.path.substring(0,l.path.length-l.title.length)+(s||l.id);l.title=s||l.id;if(u){l.url=u;l.text=L.decodeURL(u,a);L.continueToWork()}}else{i.splice(o,1);e||n.Delay()}}else if(!(n.dirs.indexOf(t)<0)){if(null!=s)return n.Delay();if(!n._expiredUrls&&L.enabled){for(var h=L.dict,f=y.binarySearch,g=0,d=i;g<d.length;g++){var c;(c=d[g].url)in h&&f(c)<0&&delete h[c]}n._expiredUrls=false}return n.Delay()}}},history:{filter:function(e,t){if(!chrome.history)return O.next([]);var n=y.history;1===k&&(k=0===C.length||0===t?3:67);if(0<C.length)return n?O.next(this.quickSearch(n)):y.use(function(t){if(!e.isOff)return O.next(O.history.quickSearch(t))});n?y.refreshInfo():setTimeout(function(){return y.use()},50);if(0===t)O.requireNormalOrIncognito(this,this.loadTabs,e);else{if(!chrome.sessions)return this.filterFill([],e,{},0,0);chrome.sessions.getRecentlyClosed(this.loadSessions.bind(this,e))}},quickSearch:function(t){var e=1==C.length&&("."===C[0][0]?Utils.commonFileExtRe.test(C[0]):(Utils.convertToUrl(C[0],null,-2),Utils.lastUrlType<=2)),n=[0,0],i=[],r=_.Match2,s=b.parts[0],o=R.ComputeRelevancy,a=T+(3==(63&k)?I:0),l=0,c=0,u=0;for(c=a;--c;)n.push(0,0);a=2*a-2;for(var h=t.length;l<h;l++){var f=t[l];if(e?s.test(f.text):r(f.text,f.title)){var g;u++;if(!((g=e?_.recencyScore(f.visit):o(f.text,f.title,f.visit))<=n[a])){for(c=a-2;0<=c&&n[c]<g;c-=2)n[c+2]=n[c],n[c+3]=n[c+1];n[c+2]=g;n[c+3]=l}}}U+=u;var d=this.getExtra;if(3===k){l=2*I;I=0}else l=0;for(;l<=a;l+=2){var g,f;if((g=n[l])<=0)break;i.push(new Suggestion("history",(f=t[n[l+1]]).url,f.text,f.title,d,g))}L.continueToWork();return i},loadTabs:function(t,e){if(!t.isOff){for(var n=Object.create(null),i=0,r=0,s=e;r<s.length;r++){var o=s[r],a=o.url,l;if((!o.incognito||!w)&&!(a in n)){n[a]=1;i++}}return this.filterFill([],t,n,I,i)}},loadSessions:function(t,e){if(!t.isOff){var i=[],r={},s=3===k?-I:0;return e.some(function(t){var e=t.tab;if(!e)return false;var n=e.url+"\n"+e.title;if(n in r)return false;r[n]=1;r[e.url]=1;0<++s&&i.push(e);return T<=i.length})?this.filterFinish(i):this.filterFill(i,t,r,-s,0)}},filterFill:function(e,n,i,r,t){chrome.history.search({text:"",maxResults:I+T+t},function(t){if(!n.isOff){t=t.filter(O.history.urlNotIn,i);if(r<0){t.length=Math.min(t.length,T-e.length);t=e.concat(t)}else 0<r&&(t=t.slice(r,r+T));return O.history.filterFinish(t)}})},filterFinish:function(t){t.forEach(this.MakeSuggestion);I=0;L.continueToWork();return O.next(t)},MakeSuggestion:function(t,e,n){var i=t.url,r=new Suggestion("history",i,L.decodeURL(i,i),t.title||"",O.history.getExtra,(99-e)/100);t.sessionId&&(r.sessionId=t.sessionId,r.label="&#8617;");n[e]=r},getExtra:function(t,e){return e},urlNotIn:function(t){return!(t.url in this)}},domains:{filter:function(t,e){if(1!==C.length||2===k||-1!==C[0].indexOf("/"))return O.next([]);var n=y;if(n.domains);else{if(!n.history)return 0<e?O.next([]):n.use(function(){if(!t.isOff)return O.domains.filter(t,0)});this.refresh(n.history)}return this.performSearch()},performSearch:function(){var t=Utils.domains,e=_.maxScoreP,n=C[0].toLowerCase(),i,r="",s=null,o=-1;if(0<I){for(var a in t)if(-1!==a.indexOf(n)){I--;U++;break}return O.next([])}_.maxScoreP=3;for(var a in t)if(-1!==a.indexOf(n)){var l=R.ComputeRelevancy(a,"",(s=t[a]).time);if(o<l){o=l;r=a}}if(r){U++;if(n.length<r.length&&!r.startsWith("www.")&&!r.startsWith(n)){var c=r.substring(r.indexOf(".")+1);if(-1!==c.indexOf(n)){var u=void 0;if(u=t[c="www."+c]){r=c;s=u}}}i=new Suggestion("domain",r=(s.https?"https://":"http://")+r,r,"",this.compute2);R.prepareHtml(i);var h=y.binarySearch(r+"/");h<0||(i.title=Utils.escapeText(y.history[h].title));--T}_.maxScoreP=e;return O.next(i?[i]:[])},refresh:function(t){this.refresh=null;for(var e=this.ParseDomainAndScheme,n=y.domains=Utils.domains,i=0,r=t;i<r.length;i++){var s=r[i],o,a=s.visit,l=e(s.url);if(l){var c=l.domain,u=l.schema,h=n[c];if(h){h.time<a&&(h.time=a);++h.count;7<=u&&(h.https=8===u?1:0)}else n[c]={time:a,count:1,https:8===u?1:0}}}chrome.history.onVisitRemoved.addListener(this.OnVisitRemoved)},OnVisitRemoved:function(t){var e=O.domains;if(t.allHistory){Utils.domains=Object.create(null);y.domains=Utils.domains}else for(var n=Utils.domains,i=e.ParseDomainAndScheme,r,s=0,o=t.urls;s<o.length;s++){var a,l=i(o[s]);l&&(r=n[l.domain])&&--r.count<=0&&delete n[l.domain]}},ParseDomainAndScheme:function(t){var e;if(t.startsWith("http://"))e=7;else if(t.startsWith("https://"))e=8;else{if(!t.startsWith("ftp://"))return null;e=6}return{domain:"__proto__"!==(t=t.substring(e,t.indexOf("/",e)))?t:".__proto__",schema:e}},compute2:function(){return 2}},tabs:{filter:function(t){O.requireNormalOrIncognito(this,this.performSearch,t)},performSearch:function(t,e){if(!t.isOff){1===k&&(k=4);for(var n=TabRecency.last,i=C.length<=0,r=[],s=[],o=[],a=0,l=e;a<l.length;a++){var c;if(!(c=l[a]).incognito||!w){var u=c.url,h=L.decodeURL(u,!c.incognito&&u);if(i||_.Match2(h,c.title)){c.text=h;var f=c.windowId;o.lastIndexOf(f)<0&&o.push(f);s.push(c)}}}U+=s.length;if(s.length<=I){4===k?I=0:I-=s.length;return O.next(r)}o=o.sort(this.SortNumbers);for(var g=i?this.computeRecency:R.ComputeWordRelevancy,d=0,m=s;d<m.length;d++){var c=m[d],p="#";1<o.length&&(p+=o.indexOf(c.windowId)+1+":");p+=""+(c.index+1);c.incognito&&(p+="*");var v=c.id,b=new Suggestion("tab",c.url,c.text,c.title,g,v);n===v&&(b.relevancy=1);b.sessionId=v;b.label=p;r.push(b)}if(4!==k&&0!==I);else if(r.sort(O.rsortByRelevancy).length>I+T||!i)if(0<I){r=r.slice(I,I+T);I=0}else T<r.length&&(r.length=T);else if(0<I){for(var y=0,S=(r=r.slice(I).concat(r.slice(0,T+I-r.length))).length,x=S;y<S;y++)r[y].relevancy=x--;I=0}L.continueToWork();return O.next(r)}},SortNumbers:function(t,e){return t-e},computeRecency:function(t,e){return TabRecency.tabs[e]||-e}},searchEngines:{_nestedEvalCounter:0,filter:function(){},preFilter:function(t,e){var n,i=C,r=0<i.length?i[0]:"",s,o;if(0===i.length);else{if(true!==e&&"\\"===r[0]&&"\\"!==r[1]){1<r.length?i[0]=r.substring(1):i.shift();r=p.substring(1).trimLeft();n=this.makeUrlSuggestion(r,"\\"+r);m=true;T--;U++;return O.next([n])}s=Settings.cache.searchEngineMap[r]}if(true===e){if(!s)return true}else{if(!s){0===d&&i.length<=1&&(d=i.length?this.calcNextMatchType():-1);return O.next([])}m=true;T--;U++;if(1===k){i.push(v);I=0}1<i.length?k=2:d=-1}if(1<i.length){i.shift();200<p.length&&(i=p.split(" ")).shift()}else i=[];var a=Utils.createSearch(i,s.url,[]),l=a.url,c=a.indexes,u=l;if("~"===r);else if(l.startsWith("vimium://")){var h=Utils.evalVimiumUrl(l.substring(9),1,true);if(h instanceof Promise)o=h;else if(h instanceof Array)switch(h[1]){case"search":C=h[0];var f=this._nestedEvalCounter++;if(12<f)break;var g=this.preFilter(t,true);f<=0&&(this._nestedEvalCounter=0);if(true!==g)return}}else l=Utils.convertToUrl(l,null,-2);n=new Suggestion("search",l,u,s.name+": "+i.join(" "),this.compute9);if(0<i.length){n.text=this.makeText(u,c);n.textSplit=R.highlight(n.text,c);n.title=R.highlight(n.title,[s.name.length+2,n.title.length])}else{n.text=Utils.DecodeURLPart(R.shortenUrl(u));n.textSplit=Utils.escapeText(n.text);n.title=Utils.escapeText(n.title)}n.pattern=s.name;if(!o)return O.next([n]);o.then(this.onPrimose.bind(this,t,n))},onPrimose:function(t,e,n){if(!t.isOff){var i=n[0];if(!i)return O.next([e]);var r=new Suggestion("math","vimium://copy "+i,i,i,this.compute9);--r.relevancy;r.title='<match style="text-decoration: none;">'+Utils.escapeText(r.title)+"<match>";r.textSplit=Utils.escapeText(n[2]);T--;U++;return O.next([e,r])}},searchKeywordMaxLength:0,timer:0,calcNextMatchType:function(){var t=C[0],e=Settings.cache.searchKeywords;if(!e){this.timer=this.timer||setTimeout(this.BuildSearchKeywords,67);return-2}if(this.searchKeywordMaxLength<=t.length)return 0;var n=this.binaryInsert(t,e);return n<e.length&&e[n].startsWith(t)?-2:0},makeText:function(t,e){var n=e.length,i,r,s;r=Utils.DecodeURLPart(0<e.length?t.substring(0,e[0]):t);if(i=Utils.IsURLHttp(r)){r=r.substring(i);i=0}if(e.length<=0)return r;s=e[0];for(;e[i]=r.length,n>++i;){r+=Utils.DecodeURLPart(t.substring(s,e[i]));s=e[i]}s<t.length&&(r+=Utils.DecodeURLPart(t.substring(s)));return r},makeUrlSuggestion:function(t,e){var n=Utils.convertToUrl(t,null,-2),i=4===Utils.lastUrlType,r=new Suggestion("search",n,e||Utils.DecodeURLPart(R.shortenUrl(n)),"",this.compute9);r.textSplit=Utils.escapeText(r.text);r.title=i?"~: "+R.highlight(t,[0,t.length]):Utils.escapeText(t);r.pattern=i?"~":"";return r},BuildSearchKeywords:function(){var t=Object.keys(Settings.cache.searchEngineMap),e=0;t.sort();for(var n=0,i=t;n<i.length;n++){var r,s=i[n].length;e<s&&(e=s)}Settings.set("searchKeywords",t);O.searchEngines.searchKeywordMaxLength=e;O.searchEngines.timer=0},binaryInsert:function(t,e){for(var n="",i=e.length-1,r=0,s=0;r<=i;)t<(n=e[s=r+i>>>1])?i=s-1:r=s+1;return r},compute9:function(){return 9}},counter:0,sugCounter:0,suggestions:null,mostRecentQuery:null,callback:null,filter:function(t){this.mostRecentQuery&&(this.mostRecentQuery.isOff=true);var e=this.mostRecentQuery={isOff:false},n=this.sugCounter=0,i=this.counter=t.length;this.suggestions=[];d=I&&-1;if(t[0]===O.searchEngines){if(i<2)return O.searchEngines.preFilter(e);O.searchEngines.preFilter(e);n=1}_.timeAgo=Date.now()-18144e5;_.maxScoreP=3*C.length||.01;0<=C.indexOf("__proto__")&&(C=C.join(" ").replace(this.protoRe," __proto_").trimLeft().split(" "));b.buildParts();for(i--;n<=i;n++)t[n].filter(e,n)},requireNormalOrIncognito:function(t,e,n){var i=e.bind(t,n);null===w&&(w=0!==TabRecency.incognito?1!==TabRecency.incognito:52<=Settings.CONST.ChromeVersion||Settings.CONST.DisallowIncognito||null);return null!==w?chrome.tabs.query({},i):chrome.windows.getCurrent(function(t){if(!n.isOff){TabRecency.incognito=(w=!t||!t.incognito)?-1:1;chrome.tabs.query({},i)}})},next:function(t){var e=this.suggestions;if(0<t.length){this.sugCounter++;this.suggestions=0===e.length?t:e.concat(t)}if(0==--this.counter){e=null;return this.finish()}},finish:function(){var t=this.suggestions;this.suggestions=null;t.sort(this.rsortByRelevancy);if(0<I){t=t.slice(I,I+l);I=0}else l<t.length&&(t.length=l);b.words=b.starts=null;if(0<C.length){var e=C[0],n=R.shortenUrl(e),i=e.length!==n.length;if(i||e.endsWith("/")&&1<e.length){C[0]=i?n:e.substring(0,e.length-1);b.fixParts()}}t.forEach(R.prepareHtml,R);var r=m&&0<t.length,s=U,o=d<0?-2===d&&0===t.length?3:0:0===t.length?0<C.length?1:0:1===this.sugCounter?2:0,a=this.callback;this.cleanGlobals();return a(t,r,o,s)},cleanGlobals:function(){this.mostRecentQuery=this.callback=w=null;C=[];p=v="";b.parts=null;_.maxScoreP=3;_.timeAgo=this.sugCounter=d=T=l=U=o=0;k=0;m=s=false},getOffset:function(){var t=p,e,n;v="";if(!((k=I=0)===t.length||(e=(t=t.slice(-5)).lastIndexOf("+"))<0||0!==e&&32!==t.charCodeAt(e-1))){t=t.substring(e);e=p.length-t.length;if(0<=(n=parseInt(t,10))&&"+"+n===t&&n<=(0<e?100:200))I=n;else if("+"!==t)return;p=p.substring(0,e-1);v=t;k=1}},protoRe:/(?:^|\s)__proto__(?=$|\s)/g,rsortByRelevancy:function(t,e){return e.relevancy-t.relevancy}},c={__proto__:null,bookm:[O.bookmarks],domain:[O.domains],history:[O.history],omni:[O.searchEngines,O.domains,O.history,O.bookmarks],search:[O.searchEngines],tab:[O.tabs]};window.Completion={filter:function(t,e,n){m=false;p=(t=t.trim())&&t.replace(Utils.spacesRe," ");O.getOffset();C=(t=p)?(200<t.length?t.substring(0,200).trimRight():t).split(" "):[];o=Math.max(50,Math.min(0|e.maxChars||128,320));s=!!e.singleLine;l=T=Math.min(Math.max(3,0|e.maxResults||10),25);U=0;O.callback=n;var i=null,r;if(1<=C.length&&2===C[0].length&&":"===C[0][0]&&(i="b"===(r=C[0][1])?c.bookm:"h"===r?c.history:"t"===r?c.tab:"d"===r?c.domain:"s"===r?c.search:"o"===r?c.omni:null)){C.shift();m=i!==c.omni;O.filter(i)}else O.filter(c[e.type]||c.omni)},removeSug:function(t,e,n){switch(e){case"tab":chrome.tabs.remove(+t,function(){var t=chrome.runtime.lastError;n(!t);return t});break;case"history":var i=!y.history||0<=y.binarySearch(t);chrome.history.deleteUrl({url:t});n(i)}}};var _={Match2:function(t,e){for(var n=b.parts,i=0,r=C.length;i<r;i++)if(!(n[i].test(t)||n[i].test(e)))return false;return true},maxScoreP:3,_emptyScores:[0,0],scoreTerm:function(t,e){var n=0,i=0;if((n=e.split(b.parts[t]).length)<1)return this._emptyScores;i=1;if(b.starts[t].test(e)){i+=1;b.words[t].test(e)&&(i+=1)}return[i,(n-1)*C[t].length]},wordRelevancy:function(t,e){var n=0,i=0,r=0,s=0,o=!!e;b.starts||b.buildOthers();for(var a=0,l=C.length;a<l;a++){var c=this.scoreTerm(a,t);s+=c[0];r+=c[1];if(o){i+=(c=this.scoreTerm(a,e))[0];n+=c[1]}}s=s/this.maxScoreP*this.normalizeDifference(r,t.length);return 0===n?e?s/2:s:s<(i=i/this.maxScoreP*this.normalizeDifference(n,e.length))?i:(s+i)/2},timeAgo:0,recencyScore:function(t){var e=Math.max(0,t-this.timeAgo)/18144e5;return e*e*.6666666666666666},normalizeDifference:function(t,e){return t<e?t/e:e/t}},b={parts:null,starts:null,words:null,buildParts:function(){var t=this.parts=[];this.starts=this.words=null;for(var e=0,n=C;e<n.length;e++){var i=n[e];t.push(new RegExp(i.replace(Utils.escapeAllRe,"\\$&"),Utils.hasUpperCase(i)?"":"i"))}},buildOthers:function(){for(var t=this.starts=[],e=this.words=[],n=0,i=C;n<i.length;n++){var r=i[n],s="\\b"+r.replace(Utils.escapeAllRe,"\\$&"),o=Utils.hasUpperCase(r)?"":"i";t.push(new RegExp(s,o));e.push(new RegExp(s+"\\b",o))}},fixParts:function(){if(this.parts){var t=C[0];this.parts[0]=new RegExp(t.replace(Utils.escapeAllRe,"\\$&"),Utils.hasUpperCase(t)?"":"i")}}},y={size:2e4,lastRefresh:0,updateCount:0,toRefreshCount:0,history:null,_callbacks:null,domains:null,use:function(t){if(this._callbacks)t&&this._callbacks.push(t);else{this._callbacks=t?[t]:[];this.lastRefresh=Date.now();chrome.history.search({text:"",maxResults:this.size,startTime:0},function(t){setTimeout(y.Clean,0,t)})}},Clean:function(t){var e=y,n,i,r;e.Clean=null;for(i=0,n=t.length;i<n;i++)t[i]={visit:(r=t[i]).lastVisitTime,text:r.url,title:r.title||"",url:r.url};r=null;setTimeout(function(){var t=y;setTimeout(function(){return L.decodeList(y.history)},100);t.history.sort(function(t,e){return e.url<t.url?1:-1});chrome.history.onVisitRemoved.addListener(t.OnVisitRemoved);chrome.history.onVisited.addListener(t.OnPageVisited)},100);e.history=t;e.use=function(t){return t?t(this.history):void 0};e._callbacks&&0<e._callbacks.length&&setTimeout(function(t){for(var e=0,n=t;e<n.length;e++){var i;(0,n[e])(y.history)}},1,e._callbacks);e._callbacks=null},OnPageVisited:function(t){var e=y,n=t.url,i=t.lastVisitTime,r=e.domains,s=e.binarySearch(n),o;s<0&&e.toRefreshCount++;99<e.updateCount++&&e.refreshInfo();if(r){var a=O.domains.ParseDomainAndScheme(n),l=void 0;if(a)if(l=r[a.domain]){l.time=i;s<0&&++l.count;7<=a.schema&&(l.https=8===a.schema?1:0)}else r[a.domain]={time:i,count:1,https:8===a.schema?1:0};else;}if(0<=s){(o=e.history[s]).visit=i;t.title&&(o.title=t.title)}else{(o={visit:i,text:"",title:t.title||"",url:n}).text=L.decodeURL(n,o);e.history.splice(~s,0,o)}},OnVisitRemoved:function(t){L.todos.length=0;var e=L.dict;if(t.allHistory){y.history=[];for(var n=Object.create(null),i=0,r=O.bookmarks.bookmarks;i<r.length;i++){var s,o=e[(s=r[i]).url];o&&(n[s.url]=o)}L.dict=n}else for(var a=y,l=y.binarySearch,c=y.history,u=0,h=t.urls;u<h.length;u++){var f=h[u],s;if(0<=(s=l(f))){c.splice(s,1);delete e[f]}}},refreshInfo:function(){if(!(this.toRefreshCount<=0&&this.updateCount<10)){var t=Date.now();if(this.toRefreshCount<=0);else{if(t<this.lastRefresh+1e3)return;setTimeout(chrome.history.search,50,{text:"",maxResults:Math.min(2e3,this.updateCount+10),startTime:this.lastRefresh},this.OnInfo)}this.lastRefresh=t;this.toRefreshCount=this.updateCount=0;return L.continueToWork()}},OnInfo:function(t){var e=y.history,n=y.binarySearch;if(!(e.length<=0))for(var i=0,r=t;i<r.length;i++){var s=r[i],o=n(s.url);if(o<0)y.OnPageVisited(s);else{var a=e[o];a.title!==s.title&&s.title&&(a.title=s.title)}}},binarySearch:function(t){for(var e="",n=y.history,i=n.length-1,r=0,s=0;r<=i;)if(t<(e=n[s=r+i>>>1].url))i=s-1;else{if(e===t)return s;r=s+1}return~r}},L={_f:decodeURIComponent,decodeURL:function(t,e){if(400<=t.length||t.indexOf("%")<0)return t;try{return this._f(t)}catch(t){}return this.dict[t]||(false!==e&&this.todos.push(e),t)},decodeList:function(t){for(var e=this,n=e._f,i=e.dict,r=e.todos,s=-1,o,a=t.length,l;;)try{for(;++s<a;)(o=t[s]).text=400<=(l=o.url).length||l.indexOf("%")<0?l:n(l);break}catch(t){o.text=i[l]||(r.push(o),l)}return this.continueToWork()},dict:Object.create(null),todos:[],_ind:-1,continueToWork:function(){if(0!==this.todos.length&&-1===this._ind){this._ind=0;setTimeout(this.Work,17,null)}},Work:function(t){for(var e=L,n;e._ind<e.todos.length;e._ind++){var i=e.todos[e._ind],r="string"==typeof i,s=r?i:i.url;if(!(n=e.dict[s])){if(!t&&!(t=e.init())){e.todos.length=0;e._ind=-1;return}t.open("GET",e._dataUrl+s.replace("#","%25"),true);return t.send()}r||(i.text=n)}},OnXHR:function(){var t=L;if(!(t._ind<0)){var e=this.responseText,n=t.todos[t._ind++];"string"!=typeof n?t.dict[n.url]=n.text=e:t.dict[n]=e;if(t._ind<t.todos.length)return t.Work(this);t.todos.length=0;t._ind=-1}},enabled:true,_dataUrl:"wait",xhr:function(){if(!this._dataUrl)return null;var t=new XMLHttpRequest;t.responseType="text";t.onload=this.OnXHR;t.onerror=this.OnXHR;return t},onUpdate:function(t){var e=!!t&&!(t=t.toLowerCase()).startsWith("utf"),n=e?"data:text/plain;charset="+t+",":"",i;if(!(n===this._dataUrl)){this._dataUrl=n;if(e)this.init===this.xhr&&setTimeout(function(){y.history&&L.decodeList(y.history);return L.decodeList(O.bookmarks.bookmarks)},100);else{this.dict=Object.create(null);this.todos.length=0}if(this.enabled!==e){this.todos=e?[]:{length:0,push:function(){}};this.enabled=e;this._ind=-1}}},init:function(){Settings.updateHooks.localeEncoding=L.onUpdate.bind(L);L.onUpdate(Settings.get("localeEncoding"));this.init=this.xhr;return this.xhr()}}},200);setTimeout(function(){Settings.postUpdate("searchEngines",null)},300);var Completion={filter:function(t,e,n){setTimeout(function(){return Completers.filter(t,e,n)},210)},removeSug:function(){}};setTimeout(function(){Utils.GC();if(chrome.storage){var l={storage:chrome.storage.sync,to_update:null,doNotSync:Object.setPrototypeOf({findModeRawQueryList:1,innerCSS:1,keyboard:1,newTabUrl_f:1},null),HandleStorageUpdate:function(t,e){if("sync"===e){Object.setPrototypeOf(t,null);for(var n in t){var i=t[n];l.storeAndPropagate(n,null!=i?i.newValue:null)}}},storeAndPropagate:function(t,e){if(t in Settings.defaults&&!(t in Settings.nonPersistent)&&this.shouldSyncKey(t)){var n=Settings.defaults[t];if(null!=e){var i=Settings.get(t),r,s,o;if(o="string"==typeof n){s=e;r=i}else{s=JSON.stringify(e);r=JSON.stringify(i)}if(s!==r){s===(i=o?n:JSON.stringify(n))&&(e=n);console.log((new Date).toLocaleString(),"sync.local: update",t,"string"==typeof e?(32<e.length?e.substring(0,30)+"...":e).replace(/\n/g,"\\n"):e);this.doSet(t,e)}}else if(null!=localStorage.getItem(t)){console.log((new Date).toLocaleString(),"sync.local: reset",t);this.doSet(t,n)}}},doSet:function(t,e){var n="keyMappings"===t?"Commands":t.startsWith("exclusion")?"Exclusions":"";if(!n)return Settings.set(t,e);Utils.require(n).then(function(){return Settings.set(t,e)});Utils.GC()},TrySet:function(t,e){l.set(t,e)},set:function(t,e){if(this.shouldSyncKey(t)){var n=this.to_update;if(!n){setTimeout(this.DoUpdate,800);n=this.to_update=Object.create(null)}n[t]=e}},DoUpdate:function(){var t=l.to_update,e=[],n=0;l.to_update=null;if(t&&Settings.sync===l.TrySet){for(var i in t)if(null!=t[i])++n;else{delete t[i];e.push(i)}if(0<e.length){console.log((new Date).toLocaleString(),"sync.cloud: reset",e.join(" "));l.storage.remove(e)}if(0<n){console.log((new Date).toLocaleString(),"sync.cloud: update",Object.keys(t).join(" "));l.storage.set(t)}}},shouldSyncKey:function(t){return!(t in this.doNotSync)}};Settings.updateHooks.vimSync=function(t){var e=chrome.storage.onChanged,n=l.HandleStorageUpdate;if(t){if(Settings.sync!==l.TrySet){e.addListener(n);Settings.sync=l.TrySet}}else{e.removeListener(n);Settings.sync=function(){}}};var t=Settings.get("vimSync");false===t||!t&&2<localStorage.length||l.storage.get(null,function(t){if(chrome.runtime.lastError){console.log((new Date).toLocaleString(),"Error: failed to get storage:",chrome.runtime.lastError,"\n\tSo disable syncing temporarily.");l.HandleStorageUpdate=l.TrySet=function(){};return chrome.runtime.lastError}Object.setPrototypeOf(t,null);var e=t.vimSync||Settings.get("vimSync");if(e){if(!t.vimSync){console.log("sync.cloud: enable vimSync");l.storage.set({vimSync:t.vimSync=e})}for(var n=[],i=0,r=localStorage.length;i<r;i++){var s;!((s=localStorage.key(i))in t)&&s in Settings.defaults&&l.shouldSyncKey(s)&&n.push(s)}for(var o=0,a=n;o<a.length;o++){var s;l.storeAndPropagate(s=a[o],null)}for(var s in t)l.storeAndPropagate(s,t[s]);Settings.postUpdate("vimSync")}})}},1e3);setTimeout(function(){function r(s,t){var e,o=Object.create(null),a=0,n=function(){console.error("Could not load action icon: "+this.getAttribute("src"))},i=function(){var t=document.createElement("canvas"),e,n,i;t.width=e=this.width,t.height=n=this.height;(i=t.getContext("2d")).clearRect(0,0,e,n);i.drawImage(this,0,0,e,n);o[e]=i.getImageData(0,0,e,n);if(!a++){t=i=null;l[s]=o;var r=c[s];delete c[s];for(e=0,n=r.length;e<n;e++)Backend.setIcon(r[e],s)}};Object.setPrototypeOf(t,null);for(var r in t){(e=new Image).onload=i,e.onerror=n;e.src=t[r]}}if(chrome.browserAction){var n=Settings.updateHooks.showActionIcon,l,c;Backend.IconBuffer=function(t){if(void 0===t)return l;if(t){if(!l){l=Object.create(null);c=Object.create(null)}}else l&&setTimeout(function(){Settings.get("showActionIcon")||(l=c=null)},200)};Backend.setIcon=function(t,e){var n,i;if(IsEdge){i=Settings.icons[e];chrome.browserAction.setIcon({tabId:t,path:i})}else if(n=l[e])chrome.browserAction.setIcon({tabId:t,imageData:n});else if(c[e])c[e].push(t);else if(i=Settings.icons[e]){setTimeout(r,0,e,i);c[e]=[t]}};Settings.updateHooks.showActionIcon=function(t){n(t);Backend.IconBuffer(t);if(!IsFirefox&&!IsEdge){var e="Vimium C";if(t)chrome.browserAction.enable();else{chrome.browserAction.disable();e+="\n\nThis icon is disabled by your settings."}chrome.browserAction.setTitle({title:e})}};Settings.postUpdate("showActionIcon")}},150);setTimeout(function(){function r(){k&&(k.suggest=null);w=T=k=S=null;f&&clearTimeout(f);u&&clearTimeout(u);g=I=f=u=0;R=x="";Utils.resetRe()}function o(){if(5e3<Date.now()-g)return r();f=setTimeout(o,3e4)}function a(){u=0;var t=k;if(t&&!t.sent){k=null;return t.suggest?e(t.key,t.suggest):void 0}}function l(t,e,n,i){if(t.suggest){k=null;var r=0<e.length,s=r?e[0]:null,o={};R=r?s.type:"";I=i;r&&(C||"sessionId"in e[0])&&(w=Object.create(null));T=[];for(var a=Object.create(null),l=0,c=n?0:1,u=e.length;l<u;l++){var h=e[l],f=h.title,g=h.url,d=h.type,m="",p=null!=h.sessionId,v=C&&!(n&&0===l)&&("tab"===d?h.sessionId!==TabRecency.last:"history"===d&&!p);g in a?g=":"+(l+c)+" "+g:a[g]=1;if(v){o.type=d;m=" ~"+(l+c)+"~"}var b={content:g,description:m=IsFirefox?h.textSplit.replace(_,"")+(f&&" - "+f.replace(_,""))+m:"<url>"+h.textSplit+(m=f?"</url><dim> - "+f+m+"</dim>":m?"</url><dim>"+m+"</dim>":"</url>")};v&&(b.deletable=true);p&&(o.sessionId=h.sessionId);if(v||p){w[g]=o;o={}}T.push(b)}if(n)if("search"===s.type){var y=s.pattern;y=(y&&"<dim>"+Utils.escapeText(y)+" - </dim>")+"<url>"+s.textSplit+"</url>";U=2;chrome.omnibox.setDefaultSuggestion({description:y});if(s=e[1])switch(s.type){case"math":T[1].description="<dim>"+s.textSplit+" = </dim><url><match>"+s.text+"</match></url>"}}else{U=3;chrome.omnibox.setDefaultSuggestion({description:T[0].description})}else if(1!==U){chrome.omnibox.setDefaultSuggestion(O);U=1}if(n){x=e[0].url;T.shift()}S=t.key;Utils.resetRe();t.suggest(T)}else k===t&&(k=null)}function e(t,e){t=t.trim().replace(Utils.spacesRe," ");if(k){var n=t===k.key;k.suggest=n?e:null;if(n)return}if(t!==S)if(1===I&&t.startsWith(S))e([]);else{k={suggest:e,key:t,sent:false};if(!u){var i=Date.now(),r=600+g-i;if(!(50<r)){k.sent=true;f||(f=setTimeout(o,3e4));g=i;w=T=null;x="";var s=I<2||!t.startsWith(S)?"omni":3===I?"search":R||"omni";return Completion.filter(t,{type:s,maxResults:d,maxChars:h,singleLine:true},l.bind(null,k))}u=setTimeout(a,r)}}else T&&e(T)}function s(n,i){var t=k;if(t&&t.suggest){t.suggest=s.bind(null,n,i);if(t.sent)return;u&&clearTimeout(u);return a()}n=n.trim().replace(Utils.spacesRe," ");if(null===S&&n)return Completion.filter(n,{type:"omni",maxResults:3,maxChars:h,singleLine:true},function(t,e){return e?c(t[0].url,i,t[0].sessionId):c(n,i)});x&&n===S&&(n=x);var e=w&&w[n]&&w[n].sessionId;r();return c(n,i,e)}function c(t,e,n){t?":"===t[0]&&/^:([1-9]|1[0-2]) /.test(t)&&(t=t.substring(" "===t[2]?3:4)):t=Utils.convertToUrl("");"file://"===t.substring(0,7).toLowerCase()&&(t=Utils.showFileUrl(t));return null!=n?Backend.gotoSession({sessionId:n}):Backend.openUrl({url:t,omni:true,reuse:"currentTab"===e?0:"newForegroundTab"===e?-1:-2})}if(chrome.omnibox){var S=null,x="",k=null,u=0,w=null,h=128,T=null,f=0,g,U=0,I=0,C=chrome.omnibox.onDeleteSuggestion&&"function"==typeof chrome.omnibox.onDeleteSuggestion.addListener,R,O={description:"<dim>Open: </dim><url>%s</url>"},_=IsFirefox?/<\/?match>/g:null,d=Settings.CONST.ChromeVersion<60?6:12;chrome.omnibox.onInputStarted.addListener(function(){chrome.windows.getCurrent(function(t){var e=t&&t.width;h=e?Math.floor((e-160/devicePixelRatio)/7.72):128});if(f)return r()});chrome.omnibox.onInputChanged.addListener(e);chrome.omnibox.onInputEntered.addListener(s);C&&chrome.omnibox.onDeleteSuggestion.addListener(function(t){var e=parseInt(t.substring(t.lastIndexOf("~",t.length-2)+1))-1,n=T&&T[e].content,i=n&&w&&w[n],r=i&&i.type;if(r){":"===n[0]&&(n=n.substring(n.indexOf(" ")+1));return Backend.removeSug({type:r,url:"tab"===r?i.sessionId:n})}console.log("Error: want to delete a suggestion but no related info found (may spend too long before deleting).")})}},600);var a=null,cb;chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener(cb=function(h){var i=h.reason;if("install"===i)i="";else{if("update"!==i)return;i=h.previousVersion}setTimeout(function(){chrome.tabs.query({status:"complete"},function(t){function e(){return new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toJSON().substring(0,19).replace("T"," ")}for(var n=chrome.tabs,i=function(){return chrome.runtime.lastError},r={file:"",allFrames:true},s=Settings.CONST.ContentScripts,o=t.length,a=s.length-1;0<=--o;){var l=t[o].url;if(!l.startsWith("chrome")&&-1!==l.indexOf("://"))for(var c=t[o].id,u=0;u<a;++u){r.file=s[u];n.executeScript(c,r,i)}}console.log("%cVimium C%c has been %cinstalled%c with %o at %c%s%c.","color:red","color:auto","color:#0c85e9","color:auto",h,"color:#0c85e9",e(),"color:auto")});if(i&&!(parseFloat(Settings.CONST.CurrentVersion)<=parseFloat(i))){i="vimium-c_upgradeNotification";chrome.notifications&&chrome.notifications.create(i,{type:"basic",iconUrl:location.origin+"/icons/icon128.png",title:"Vimium C Upgrade",message:"Vimium C (renamed from Vimium++) has been upgraded to version "+Settings.CONST.CurrentVersionName+". Click here for more information.",isClickable:true},function(t){var e=chrome.notifications,n=chrome.runtime.lastError;chrome.notifications=null;if(n)return n;i=t||i;e.onClicked.addListener(function(t){if(t===i)return Backend.focus({url:"https://github.com/gdh1995/vimium-c#release-notes"})})})}},500)});Utils.GC=function(){function n(){var t=Date.now()-i;if(t<6e4&&-5e3<t)r=setTimeout(n,6e4-t);else{r=0;var e;if(!(!!chrome.extension.getViews&&0<chrome.extension.getViews().filter(function(t){return t.location.pathname.startsWith("/pages/")}).length)){Settings.updateHooks.keyMappings=void 0;Commands=null;if(Exclusions&&0===Exclusions.rules.length){Exclusions.destroy();Exclusions=null}}}}var i=0,r=0;Utils.GC=function(){if(Commands||Exclusions){i=Date.now();0<r||(r=setTimeout(n,6e4))}};return Utils.GC()};setTimeout(function(){chrome.runtime.onInstalled.removeListener(cb);document.documentElement.textContent="";cb=function(t){console.log(a=t)};null!=localStorage.getItem("log|lastPartlyLoad")&&localStorage.removeItem("log|lastPartlyLoad");Utils.resetRe()},1200);