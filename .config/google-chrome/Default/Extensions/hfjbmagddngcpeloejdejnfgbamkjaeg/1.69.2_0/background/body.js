"use strict";var Utils={fetchHttpContents:function(e,t,n){(n=n||new XMLHttpRequest).open("GET",e,true);n.responseType="text";n.onload=t;n.send();return n},extendIf:function(e,t){for(var n in t)n in e||(e[n]=t[n]);return e},_reToReset:/a?/,resetRe:function(){return this._reToReset.test("")},escapeText:function(e){function t(e){var t=e.charCodeAt(0);return 38===t?"&amp;":39===t?"&apos;":t<39?"&quot;":60===t?"&lt;":"&gt;"}var n=/["&'<>]/g;this.escapeText=function(e){return e.replace(n,t)};return this.escapeText(e)},unescapeHTML:function(e){var t=/\&(amp|gt|lt|nbsp);/g,n=Object.setPrototypeOf({amp:"&",gt:">",lt:"<",nbsp:" "},null),r=function(e,t){return n[t]};this.unescapeHTML=function(){return e.replace(t,r)};return this.unescapeHTML(e)},isJSUrl:function(e){return 58===e.charCodeAt(10)&&"javascript:"===e.substring(0,11).toLowerCase()},isRefusingIncognito:function(e){return(e=e.toLowerCase()).startsWith("chrome://")?!e.startsWith("chrome://downloads"):!e.startsWith(Settings.CONST.ChromeInnerNewTab)&&e.startsWith("chrome")},_nonENTlds:".\u4e2d\u4fe1.\u4e2d\u56fd.\u4e2d\u570b.\u4e2d\u6587\u7f51.\u4f01\u4e1a.\u4f5b\u5c71.\u4fe1\u606f.\u516c\u53f8.\u516c\u76ca.\u5546\u57ce.\u5546\u5e97.\u5546\u6807.\u5728\u7ebf.\u5a31\u4e50.\u5e7f\u4e1c.\u6211\u7231\u4f60.\u624b\u673a.\u62db\u8058.\u653f\u52a1.\u6e38\u620f.\u7f51\u5740.\u7f51\u5e97.\u7f51\u5e97.\u7f51\u7edc.\u8d2d\u7269.\u96c6\u56e2.\u9910\u5385",_tlds:["","",".ac.ad.ae.af.ag.ai.al.am.ao.aq.ar.as.at.au.aw.ax.az.ba.bb.bd.be.bf.bg.bh.bi.bj.bm.bn.bo.br.bs.bt.bv.bw.by.bz.ca.cc.cd.cf.cg.ch.ci.ck.cl.cm.cn.co.cr.cu.cv.cw.cx.cy.cz.de.dj.dk.dm.do.dz.ec.ee.eg.er.es.et.eu.fi.fj.fk.fm.fo.fr.ga.gb.gd.ge.gf.gg.gh.gi.gl.gm.gn.gp.gq.gr.gs.gt.gu.gw.gy.hk.hm.hn.hr.ht.hu.id.ie.il.im.in.io.iq.ir.is.it.je.jm.jo.jp.ke.kg.kh.ki.km.kn.kp.kr.kw.ky.kz.la.lb.lc.li.lk.lr.ls.lt.lu.lv.ly.ma.mc.md.me.mg.mh.mk.ml.mm.mn.mo.mp.mq.mr.ms.mt.mu.mv.mw.mx.my.mz.na.nc.ne.nf.ng.ni.nl.no.np.nr.nu.nz.om.pa.pe.pf.pg.ph.pk.pl.pm.pn.pr.ps.pt.pw.py.qa.re.ro.rs.ru.rw.sa.sb.sc.sd.se.sg.sh.si.sj.sk.sl.sm.sn.so.sr.st.su.sv.sx.sy.sz.tc.td.tf.tg.th.tj.tk.tl.tm.tn.to.tr.tt.tv.tw.tz.ua.ug.uk.us.uy.uz.va.vc.ve.vg.vi.vn.vu.wf.ws.ye.yt.za.zm.zw",".abc.art.bid.biz.cat.com.dev.edu.fun.gov.ink.int.kim.law.lol.ltd.men.mil.moe.mom.mtn.net.new.one.org.pro.pub.red.ren.run.tel.top.vip.win.xin.xxx.xyz",".aero.arpa.asia.auto.band.beer.chat.city.club.cool.coop.date.fund.game.gift.gold.guru.help.info.jobs.life.link.live.loan.love.mobi.name.news.pics.plus.post.shop.show.site.sohu.team.tech.wang.wiki.work.zone",".citic.click.email.games.group.local.onion.party.photo.press.rocks.space.store.today.trade.video.world",".center.design.lawyer.market.museum.online.social.studio.travel",".company.science.website",".engineer.software"],domains:Object.create(null),hostRe:/^([^:]+(:[^:]+)?@)?([^:]+|\[[^\]]+])(:\d{2,5})?$/,_ipv4Re:/^\d{1,3}(?:\.\d{1,3}){3}$/,_ipv6Re:/^\[[\da-f]{0,4}(?::[\da-f]{0,4}){1,5}(?:(?::[\da-f]{0,4}){1,2}|:\d{0,3}(?:\.\d{0,3}){3})]$/,_lfSpacesRe:/[\r\n]+[\t \xa0]*/g,spacesRe:/\s+/g,A0Re:/\xa0/g,_nonENTldRe:/[^a-z]/,protocolRe:/^[a-z][\+\-\.\da-z]+:\/\//,_nonENDoaminRe:/[^.\da-z\-]|^-/,_jsNotEscapeRe:/["\[\]{}\u00ff-\uffff]|%(?![\dA-F]{2}|[\da-f]{2})/,quotedStringRe:/^"[^"]*"$|^'[^']*'$|^\u201c[^\u201d]*\u201d$/,filePathRe:/^[A-Za-z]:(?:[\\/][^:*?"<>|]*)?$|^\/(?:Users|home|root)\/[^:*?"<>|]+$/,_backSlashRe:/\\/g,lastUrlType:0,convertToUrl:function(e,t,n){e=e.trim();this.lastUrlType=0;if(this.isJSUrl(e)){Settings.CONST.ChromeVersion<46&&0<e.indexOf("%",11)&&!this._jsNotEscapeRe.test(e)&&(e=this.DecodeURLPart(e));e=e.replace(this.A0Re," ");this.resetRe();return e}var r=-1,i=0,s=false,o,a,l,u;e='"'===(l=e.replace(this._lfSpacesRe,"").replace(this.A0Re," "))[0]&&l.endsWith('"')?l.slice(1,-1):l;if(this.filePathRe.test(e)){":"===e[1]&&(e=e[0].toUpperCase()+":/"+e.substring(3).replace(this._backSlashRe,"/"));this.resetRe();return"file://"+("/"===e[0]?e:"/"+e)}if(e.startsWith("\\\\")&&3<e.length){(e=e.substring(2).replace(this._backSlashRe,"/")).lastIndexOf("/")<=0&&(e+="/");this.resetRe();return"file://"+e}0<(o=(e=l.toLowerCase()).indexOf(" "))&&(e=e.substring(0,o));if(0===(o=e.indexOf(":")))r=4;else if(-1!==o&&this.protocolRe.test(e))if(e.startsWith("vimium:")){r=3;(n|=0)<-1||!(e=l.substring(9))?l="vimium://"+l.substring(9):-1!==n&&(l=this.evalVimiumUrl(e,n))?"string"!=typeof l&&(r=5):l=this.formatVimiumUrl(e,false,n)}else(-1===(a=e.indexOf("/",o+3))?e.length<l.length:e.charCodeAt(a+1)<33)?r=4:this._nonENTldRe.test(e.substring(0,o))?r=32<(o=e.charCodeAt(o+3))&&47!==o?0:4:e.startsWith("file:")?r=0:e.startsWith("chrome:")?r=e.length<l.length&&-1===e.indexOf("/",9)?4:0:e=e.substring(o+3,-1!==a?a:void 0);else{-1!==o&&e.lastIndexOf("/",o)<0&&(r=this.checkSpecialSchemes(l,o,e.length%l.length));i=2;a=l.length;if(-1===r&&e.startsWith("//")){e=e.substring(2);i=1;a-=2}if(-1!==r);else if((o=e.indexOf("/"))<=0)(0===o||e.length<a)&&(r=4);else if(a<=e.length||32<e.charCodeAt(o+1)){s=o+1<e.length;e=e.substring(0,o)}else r=4}-1===r&&0<=e.indexOf("%")&&0<=(e=Utils.DecodeURLPart(e)).indexOf("/")&&(r=4);-1===r&&e.startsWith(".")&&(e=e.substring(1));if(-1!==r);else if(u=this.hostRe.exec(e))if((e=u[3]).endsWith("]"))r=this.isIPHost(e,6)?i:4;else if(e.endsWith("localhost")||this.isIPHost(e,4)||u[4]&&s)r=i;else if((o=e.lastIndexOf("."))<0||0===(r=this.isTld(e.substring(o+1)))){o<0&&"__proto__"===e&&(e="."+e);a=e.length-o-1;r=2!==i&&(o<0||3<=a&&a<=5)||0<this.checkInDomain(e,u[4])?i:4}else r=e.length!==o+3&&1===r&&this._nonENDoaminRe.test(e)?4:2!==i||s?i:e.endsWith(".so")&&e.startsWith("lib")&&e.indexOf(".")===e.length-3?4:u[2]||u[4]||!u[1]||e.startsWith("ftp")?2:e.startsWith("mail")||0<e.indexOf(".mail")||(a=e.indexOf("."))===o?4:e.indexOf(".",++a)!==o?2:e.length===o+3&&1===r&&this.isTld(e.substring(a,o),true)?4:2;else{r=4;if(e.length===l.length&&this.isIPHost(e="["+e+"]",6)){l=e;r=2}}this.resetRe();return 0===(this.lastUrlType=r)?l:4===r?this.createSearchUrl(l.split(this.spacesRe),t||"~",n):r<=2?(2===this.checkInDomain(e,u&&u[4])?"https:":"http:")+(2===r?"//":"")+l:l},checkInDomain:function(e,t){var n=t&&this.domains[e+t]||this.domains[e];return n?n.https?2:1:0},checkSpecialSchemes:function(e,t,n){var r="/"===e[t+1];switch(e.substring(0,t)){case"about":return r?4:0<n||0<e.indexOf("@",t)?-1:0;case"blob":case"view-source":if((e=e.substring(t+1)).startsWith("blob:")||e.startsWith("view-source:"))return 4;this.convertToUrl(e,null,-2);return this.lastUrlType<=2?0:4;case"data":return r?4:(t=e.indexOf(",",t))<0||0<n&&n<t?-1:0;case"file":return 0;case"filesystem":e=e.substring(t+1);if(!this.protocolRe.test(e))return 4;this.convertToUrl(e,null,-2);return 0===this.lastUrlType&&/[^/]\/(?:persistent|temporary)(?:\/|$)/.test(e)?0:4;case"magnet":return"?"!==e[t+1]?-1:0;case"mailto":return r?4:0<(t=e.indexOf("/",t))&&e.lastIndexOf("?",t)<0?-1:0;case"tel":return/\d/.test(e)?0:4;default:return r?4:-1}},removeComposedScheme:function(e){var t=e.startsWith("filesystem:")?11:e.startsWith("view-source:")?12:0;return t?e.substring(t):e},detectLinkDeclaration:function(e){var t=e.indexOf("\uff1a")+1||e.indexOf(":")+1;if(!t||"/"===e[t])return e;var n=e.substring(0,t-1).trim().toLowerCase();if("link"!==n&&"\u94fe\u63a5"!==n)return e;var r=e.substring(t).trim();0<(t=r.indexOf(" "))&&(r=r.substring(0,t));0<=".;,\uff1b\uff0c\u3002".indexOf(r[r.length-1])&&(r=r.slice(0,-1));r=this.convertToUrl(r,null,-2);return Utils.lastUrlType<=2&&!r.startsWith("vimium:")?r:e},isTld:function(e,t){return!t&&this._nonENTldRe.test(e)?-1!==this._nonENTlds.indexOf("."+e+".")?2:0:e.length<this._tlds.length&&0<this._tlds[e.length].indexOf(e)?1:0},isIPHost:function(e,t){if(6!==t&&this._ipv4Re.test(e)||4!==t&&this._ipv6Re.test(e))try{new URL("http://"+e);return true}catch(e){}return false},commonFileExtRe:/\.[0-9A-Za-z]+$/,formatVimiumUrl:function(e,t,n){var r,i="",s,o=e.trim();if(!o)return t?"":location.origin+"/pages/";if(0<(r=o.indexOf(" "))){i=o.substring(r+1).trim();o=o.substring(0,r)}if(!(this.commonFileExtRe.test(o)||this._queryRe.test(o))){o=o.toLowerCase();if(s=Settings.CONST.RedirectedUrls[o])o=s;else{if("newtab"===o)return Settings.cache.newTabUrl_f;if("/"===o[0]||0<=Settings.CONST.KnownPages.indexOf(o))o+=".html";else{if(1===n||-1===n)return"vimium://"+e.trim();o="show.html#!url vimium://"+o}}}t||s&&!(s.indexOf("://")<0)||(o=location.origin+("/"===o[0]?"":"/pages/")+o);return o+(i&&(0<o.indexOf("#")?" ":"#!")+i)},_nestedEvalCounter:0,_vimiumCmdRe:/^[a-z][\da-z\-]*(?:\.[a-z][\da-z\-]*)*$/i,_vimiumFileExtRe:/\.(?:css|html|js)$/i,_mathSpaceRe:/[\s+,\uff0c]+/g,evalVimiumUrl:function(n,e,t){var r,i,s,o,a;if((e|=0)<0||!(i=n=n.trim())||(r=n.indexOf(" "))<=0||!this._vimiumCmdRe.test(i=n.substring(0,r).toLowerCase())||this._vimiumFileExtRe.test(i))return null;if(!(n=n.substring(r+1).trimLeft()))return null;if(1===e)switch(i){case"sum":case"mul":n=n.replace(this._mathSpaceRe,"sum"===i?" + ":" * ");i="e";break;case"avg":case"average":n="("+(s=n.split(this._mathSpaceRe)).join(" + ")+") / "+s.length;i="e"}if(1===e)switch(i){case"e":case"exec":case"eval":case"expr":case"calc":case"m":case"math":return this.require("MathParser").catch(function(){return null}).then(function(e){Utils.quotedStringRe.test(n)&&(n=n.slice(1,-1));n=n.replace(/\uff0c/g," ");var t;return[Utils.tryEvalMath(n,e)||"","math",n]});case"error":return[n,"ERROR"]}else if(2===e)switch(i){case"status":case"state":return[n.toLowerCase(),"status"];case"url-copy":case"search-copy":case"search.copy":case"copy-url":if((a=this.convertToUrl(n,null,1))instanceof Promise)return a.then(function(e){var t=e[0]||e[2]||"";t=t instanceof Array?t.join(" "):t;VClipboard.copy(t);return[t,"copy"]});a=5===this.lastUrlType&&a instanceof Array?a[0]:a;n=a instanceof Array?a.join(" "):a;case"c":case"cp":case"copy":VClipboard.copy(n);return[n,"copy"]}switch(i){case"p":case"parse":case"decode":(i=n.split(" ",1)[0]).indexOf("/")<0&&i.toLowerCase().indexOf("%2f")<0?n=n.substring(i.length+1).trimLeft():i="~";s=[n=this.decodeEscapedURL(n)];n=this.convertToUrl(n);4!==this.lastUrlType&&(o=Backend.parse({url:n}))?""===o.url?s=[i]:(s=o.url.split(" ")).unshift(i):s=s[0].split(this.spacesRe);break;case"u":case"url":case"search":s=this.decodeEscapedURL(n).split(this.spacesRe);break;default:return null}if(t)return[s,"search"];if(12<(r=this._nestedEvalCounter++))return null;if(12===r)return this.createSearchUrl(s);if(0<r)return this.createSearchUrl(s,"",e);a=this.createSearchUrl(s,"",e);this._nestedEvalCounter=0;return a},tryEvalMath:function(e,t){var n=null;if((t=t||window.MathParser||{}).evaluate){try{n="function"==typeof(n=t.evaluate(e))?null:""+n}catch(e){}t.expression=""}return n},jsLoadingTimeout:300,require:function(r){var e=window[r];return e?Promise.resolve(e):window[r]=new Promise(function(e,t){var n=document.createElement("script");n.src=Settings.CONST[r];n.onerror=function(){this.remove();t("ImportError: "+r)};n.onload=function(){this.remove();window[r]instanceof Promise?t("ImportError: "+r):e(window[r])};document.documentElement.appendChild(n)})},searchWordRe:/\$([sS])(?:\{([^}]*)})?/g,searchWordRe2:/([^\\]|^)%([sS])/g,searchVariable:/\$([+-]?\d+)/g,createSearchUrl:function(e,t,n){var r,i=Settings.cache.searchEngineMap[t||e[0]];if(i){t||(t=e.shift());r=this.createSearch(e,i.url)}else r=e.join(" ");if("~"!==t)return this.convertToUrl(r,null,n);this.lastUrlType=4;return r},createSearch:function(s,e,o){var a,l=0;e=e.replace(this.searchWordRe,function(e,r,t,n){var i;if("S"===r){i=s;r=" "}else{i=a||(a=s.map(encodeURIComponent));r="+"}if(0===i.length)return"";t=t&&-1!==t.indexOf("$")?t.replace(Utils.searchVariable,function(e,t){var n=parseInt(t,10);if(0==n)return i.join(r);if(n<0)n+=i.length+1;else if("+"===t[0])return i.slice(n-1).join(r);return i[n-1]||""}):i.join(null!=t?t:r);if(null!=o){o.push(n+=l,n+t.length);l+=t.length-e.length}return t});this.resetRe();return null==o?e:{url:e,indexes:o}},DecodeURLPart:function(e,t){if(!e)return"";try{e=(t||decodeURIComponent)(e)}catch(e){}return e},escapedColonOrSlashRe:/%(?:3[aA]|2[fF])/,decodeEscapedURL:function(e){return e.indexOf("://")<0&&this.escapedColonOrSlashRe.test(e)?this.DecodeURLPart(e).trim():e},imageFileRe:/\.(?:bmp|gif|ico|jpe?g|png|tiff?|webp)$/i,showFileUrl:function(e){return this.imageFileRe.test(e)?this.formatVimiumUrl("show image "+e,false,0):e},reformatURL:function(e){var t=e.indexOf(":");if(t<=0)return e;if("://"===e.substring(t,t+3)){if((t=e.indexOf("/",t+3))<0)return e.toLowerCase()+"/";if(7===t&&"file"===e.substring(0,4).toLowerCase())return"file:///"+((t=":"===e[9]?3:0)?e[8].toUpperCase()+":/":"")+e.substring(t+8)}var n=e.substring(0,t),r=n.toLowerCase();return n!==r?r+e.substring(t):e},parseSearchEngines:function(e,t){for(var n,r,i,s,o,a,l=/[^\\]\//,u=[],c=/\\\s/g,d=/\s/,f=/\\s/g,h=/\\:/g,m=/\\%/g,g=/\sre=/i,p=/%24([sS])/g,b=this.searchWordRe,v=function(e){return!!((e=e.trim())&&"__proto__"!==e&&e.length<51)&&(t[e]=o,true)},w=0,S=e.replace(/\\\n/g,"").split("\n");w<S.length;w++){var x=S[w];if(35<(x=x.trim()).charCodeAt(0)){a=0;for(;a=x.indexOf(":",a+1),92===x.charCodeAt(a-1););if(!(a<=0)&&(s=x.substring(0,a).trimRight())){n=s.replace(h,":").split("|");if(x=x.substring(a+1).trimLeft()){if(0<(a=(s=x.replace(c,"\\s")).search(d))){e=x.substring(a);x=s.substring(0,a);a=e.search(g)}else{x=s;e=""}x=x.replace(f," ").trim().replace(this.searchWordRe2,"$1$$$2").replace(m,"%");o={name:"",url:x};if(0!==(n=n.filter(v)).length){if(-1===a){b.lastIndex=0;var C=b.exec(x);if(C&&(a=C.index+1)){(s=C[2])?x=x.replace(b,"$$$1"):s="s"===C[1]?"+":" ";x=this.convertToUrl(x,null,-1);2<this.lastUrlType?a=(x=x.replace(p,"$$$1")).search(b)+1:0!==this.lastUrlType&&(a+=2===this.lastUrlType?7:5);if(r=this.reparseSearchUrl(x.toLowerCase(),a)){if(0<=s.indexOf("$")){s=s.replace(this.searchVariable,"(.*)");i=new RegExp("^"+s,this.alphaRe.test(s)?"i":"")}else i=s.trim()||" ";u.push({prefix:r.prefix,matcher:r.matcher,name:n[0].trimRight(),delimiter:i})}}}else if(47===e.charCodeAt(a+4)){s=1<a?e.substring(1,a).trim():"";a=(e=e.substring(a+5)).search(l)+1;x=e.substring(0,a);a=(e=e.substring(a+1)).search(d);var I=this.makeRegexp(x,0<=a?e.substring(0,a):e);if(I){s=this.prepareReparsingPrefix(s);u.push({prefix:s,matcher:I,name:n[0].trimRight(),delimiter:0<=o.url.lastIndexOf("$S")?" ":"+"})}e=0<=a?e.substring(a+1):""}else e=e.substring(a+4);e=e.trimLeft();o.name=e?this.DecodeURLPart(e):n[n.length-1].trimLeft()}}}}}return u},escapeAllRe:/[$()*+.?\[\\\]\^{|}]/g,_spaceOrPlusRe:/\\\+|%20| /g,_queryRe:/[#?]/,alphaRe:/[a-z]/i,reparseSearchUrl:function(e,t){if(!this.protocolRe.test(e))return null;var n,r,i,s;n=e.substring(0,t-1);if(t=Math.max(n.lastIndexOf("?"),n.lastIndexOf("#"))+1){i=r=n.substring(t);n=n.substring(0,n.search(this._queryRe));(s=r.lastIndexOf("&")+1)&&(i=r.substring(s));if(i&&1<=i.indexOf("="))r="[#&?]";else{i=r;r="#"===e[t-1]?"#":i?"[#?]":"\\?"}e="([^#&?]*)"}else{r="^([^#?]*)";(i=e.substring(n.length+2))&&(t=i.search(this._queryRe)+1)&&(i=i.substring(0,t-1));e=""}i=i&&i.replace(this.escapeAllRe,"\\$&").replace(this._spaceOrPlusRe,"(?:\\+|%20| )");return{prefix:n=this.prepareReparsingPrefix(n),matcher:new RegExp(r+i+e,this.alphaRe.test(i)?"i":"")}},IsURLHttp:function(e){return(e=e.substring(0,8).toLowerCase()).startsWith("http://")?7:"https://"===e?8:0},prepareReparsingPrefix:function(e){var t=e.substring(0,9).toLowerCase();this.IsURLHttp(t)?e=e.substring(58===e.charCodeAt(4)?7:8):"vimium://"===t&&(e=this.formatVimiumUrl(e.substring(9),false,-1));return e},makeRegexp:function(t,n,r){try{return new RegExp(t,n)}catch(e){false===r||console.log("%c/%s/%s","color:#C41A16",t,n,"is not a valid regexp.")}return null},keyRe:/<(?!<)(?:.-){0,3}..*?>|./g,makeCommand:function(e,t,n){var r;n||(n=CommandsData.availableCommands[e]);r=n.length<4?null:n[3];if(t){var i=t.count;if(r){r instanceof Object&&Object.setPrototypeOf(r,null);Utils.extendIf(t,r)}null!=i?t.count=1===n[1]?1:(parseInt(i)||1)*(r&&r.count||1):r&&"count"in r&&(t.count=r.count)}else t=r;return{alias:n.length<5?e:n[4],background:n[2],command:e,options:t,repeat:n[1]}},getNull:function(){return null},GC:function(){},hasUpperCase:function(e){return e.toLowerCase()!==e}};if(!"".startsWith){String.prototype.startsWith=function(e){return e.length<=this.length&&0===this.lastIndexOf(e,0)};"".endsWith||(String.prototype.endsWith=function(e){var t=this.length-e.length;return 0<=t&&this.indexOf(e,t)===t})}var NotChrome="undefined"!=typeof browser&&null!=(browser&&browser.runtime)&&!location.protocol.startsWith("chrome");NotChrome&&(window.chrome=browser);var Settings={cache:Object.create(null),temp:{shownHash:null},bufferToLoad:Object.create(null),newTabs:Object.create(null),extWhiteList:null,get:function(e,t){if(e in this.cache)return this.cache[e];var n=this.defaults[e],r=localStorage.getItem(e),i=null==r?n:"string"==typeof n?r:false===n||true===n?"true"===r:JSON.parse(r);t&&(this.cache[e]=i);return i},set:function(e,t){this.cache[e]=t;if(!(e in this.nonPersistent)){var n=this.defaults[e];if(t===n){localStorage.removeItem(e);this.sync(e,null)}else{localStorage.setItem(e,"string"==typeof n?t:JSON.stringify(t));this.sync(e,t)}}var r;if(r=this.updateHooks[e])return r.call(this,t,e)},postUpdate:function(e,t){return this.updateHooks[e].call(this,void 0!==t?t:this.get(e),e)},broadcast:function(e){var t=Backend.indexPorts();for(var n in t)for(var r=t[n],i=r.length;0<--i;)r[i].postMessage(e)},updateHooks:{__proto__:null,bufferToLoad:function(){for(var e=this.valuesToLoad,t=this.bufferToLoad,n=e.length;0<=--n;){var r=e[n];t[r]=this.get(r)}},grabBackFocus:function(e){this.bufferToLoad.grabFocus=e},extWhiteList:function(e){var t=this.extWhiteList,n=this.extWhiteList=Object.create(null);if(t)for(var r in t)false===t[r]&&(n[r]=false);if(e)for(var i=e.split("\n"),s=i.length,o=/^[\dA-Za-z]/;0<=--s;)(e=i[s].trim())&&o.test(e)&&(n[e]=true)},newTabUrl:function(e){e=/^\/?pages\/[a-z]+.html\b/i.test(e)?chrome.runtime.getURL(e):Utils.convertToUrl(e);return this.set("newTabUrl_f",e)},searchEngines:function(){return this.set("searchEngineMap",Object.create(null))},searchEngineMap:function(e){"searchKeywords"in this.cache&&this.set("searchKeywords",null);var t=Utils.parseSearchEngines("~:"+this.get("searchUrl")+"\n"+this.get("searchEngines"),e);return this.set("searchEngineRules",t)},searchUrl:function(e){if(e)Utils.parseSearchEngines("~:"+e,this.cache.searchEngineMap);else{this.cache.searchEngineMap={"~":{name:"~",url:this.get("searchUrl").split(" ",1)[0]}};this.cache.searchEngineRules=[];if(e=this.get("newTabUrl_f",true))return this.updateHooks.newTabUrl_f(e)}return this.postUpdate("newTabUrl")},baseCSS:function(e){var t=this.CONST.StyleCacheId,n=t.substring(t.indexOf(",")+1),r=0<=n.lastIndexOf("a");if(r){var i=e.indexOf("all:"),s=e.lastIndexOf("{",i);e=e.substring(0,s+1)+e.substring(i)}else e=e.replace(/all:\s?initial;?/,"");this.CONST.ChromeVersion<48&&(e+="\n.HUD,.IH,.LH{border-width:1px}");if(n.lastIndexOf("s")<0){var o=e.indexOf("}")+1,a=e.indexOf("}",o)+1,l=e.substring(a);r&&(l=l.replace(/\b[IL]H\s?\{/g,"$&all:inherit;"));l+="\n.R:before,.R:after{display:none!important}";e="div#VimiumUI"+e.substring(5,o)+l.replace(/\.[A-Z]/g,"#VimiumUI $&")}e=t+e.length+"\n"+e;var u=this.get("userDefinedCss");u&&(e+="\n"+u);return this.set("innerCSS",e)},userDefinedCss:function(e){var t=localStorage.getItem("innerCSS"),n=t.indexOf("\n");t=t.substring(0,n+1+ +t.substring(0,n).split(",")[2]);this.set("innerCSS",e?t+"\n"+e:t);var r=Backend.indexPorts(),i={name:"showHUD",CSS:this.cache.innerCSS};for(var s in r)for(var o=r[s],a=o.length;0<--a;)4&o[a].sender.flags&&o[a].postMessage(i)},innerCSS:function(e){this.cache.innerCSS=e.substring(e.indexOf("\n")+1)},vomnibarPage:function(e){if(e===this.defaults.vomnibarPage)e=this.CONST.VomnibarPageInner;else if(e.startsWith("front/"))e=chrome.runtime.getURL(e);else{e=Utils.convertToUrl(e);e=!(e=Utils.reformatURL(e)).startsWith("chrome")&&this.CONST.ChromeVersion<50?this.CONST.VomnibarPageInner:e.replace(":version",""+parseFloat(this.CONST.CurrentVersion))}this.set("vomnibarPage_f",e)}},fetchFile:function(e,t){if(t&&e in this.cache){t();return null}var n=this.CONST.XHRFiles[e];if(!n)throw Error("unknown file: "+e);return Utils.fetchHttpContents(n,function(){"baseCSS"===e?Settings.postUpdate(e,this.responseText):Settings.set(e,this.responseText);t&&t()})},defaults:{__proto__:null,deepHints:false,dialogMode:false,exclusionListenHash:true,exclusionOnlyFirstMatch:false,exclusionRules:[{pattern:"^https?://mail.google.com/",passKeys:""}],extWhiteList:"# modified { Vomnibar Page, X New Tab, PDF Viewer }\nekohaelnhhdhbccgefjmjpdjoijhojgd\nhdnehngglnbnehkfcidabjckinphnief\nnacjakoppgmdcpemlfnfegmlhipddanj",findModeRawQueryList:"",grabBackFocus:false,hideHud:false,innerCSS:"",keyboard:[500,33],keyMappings:"",linkHintCharacters:"sadjklewcmpgh",localeEncoding:"gbk",newTabUrl:"",newTabUrl_f:"",nextPatterns:"\u4e0b\u9875,\u4e0b\u4e00\u9875,\u4e0b\u4e00\u7ae0,\u540e\u4e00\u9875,next,more,newer,>,\u203a,\u2192,\xbb,\u226b,>>",previousPatterns:"\u4e0a\u9875,\u4e0a\u4e00\u9875,\u4e0a\u4e00\u7ae0,\u524d\u4e00\u9875,prev,previous,back,older,<,\u2039,\u2190,\xab,\u226a,<<",regexFindMode:false,scrollStepSize:100,searchUrl:"https://www.baidu.com/s?ie=utf-8&wd=%s Baidu",searchEngines:"b|ba|baidu: https://www.baidu.com/s?ie=utf-8&wd=%s Baidu\nbi|bing: https://www.bing.com/search?q=%s Bing\ng|go|gg|google: https://www.google.com/search?q=%s Google\njs\\:|Js: javascript:\\ $S; Javascript\nw|wiki:\\\n  https://www.wikipedia.org/w/index.php?search=%s Wikipedia\n\n# More examples.\n#\n# (Vimium C supports search completion Google, Wikipedia,\n# and so on, as above, and for these.)\n#\n# l: https://www.google.com/search?q=%s&btnI I'm feeling lucky\n# y: https://www.youtube.com/results?search_query=%s Youtube\n# gm: https://www.google.com/maps?q=%s Google maps\n# d: https://duckduckgo.com/?q=%s DuckDuckGo\n# az: https://www.amazon.com/s/?field-keywords=%s Amazon\n# qw: https://www.qwant.com/?q=%s Qwant",searchEngineMap:{},showActionIcon:true,showAdvancedCommands:false,showAdvancedOptions:false,smoothScroll:true,userDefinedCss:"",vimSync:null,vomnibarPage:""},nonPersistent:{__proto__:null,baseCSS:1,exclusionTemplate:1,helpDialog:1,searchEngineMap:1,searchEngineRules:1,searchKeywords:1,vomnibarPage_f:1},frontUpdateAllowed:{__proto__:null,showAdvancedCommands:1},icons:[{19:"/icons/enabled_19.png",38:"/icons/enabled_38.png"},{19:"/icons/partial_19.png",38:"/icons/partial_38.png"},{19:"/icons/disabled_19.png",38:"/icons/disabled_38.png"}],valuesToLoad:["deepHints","keyboard","linkHintCharacters","regexFindMode","scrollStepSize","smoothScroll"],sync:function(){},CONST:{AllowClipboardRead:true,BaseCSSLength:0,BrowserNewTab:"about:newtab",BrowserNewTab2:"chrome://newtab",ChromeInnerNewTab:"chrome-search://local-ntp/local-ntp.html",DisallowIncognito:false,VimiumNewTab:"",ChromeVersion:35,ContentScripts:null,CurrentVersion:"",CurrentVersionName:"",StyleCacheId:"",KnownPages:["blank","newtab","options","show"],MathParser:"/lib/math_parser.js",HelpDialog:"/background/help_dialog.js",Commands:"/background/commands.js",Exclusions:"/background/exclusions.js",XHRFiles:{baseCSS:"/front/vimium.min.css",exclusionTemplate:"/front/exclusions.html",helpDialog:"/front/help_dialog.html"},InjectEnd:"content/inject_end.js",OptionsPage:"pages/options.html",Platform:"",PolyFill:"lib/polyfill.js",RedirectedUrls:{about:"https://github.com/gdh1995/vimium-c",help:"https://github.com/philc/vimium/wiki",license:"https://raw.githubusercontent.com/gdh1995/vimium-c/master/LICENSE.txt",permissions:"https://github.com/gdh1995/vimium-c/blob/master/PRIVACY-POLICY.md#permissions-required",policy:"https://github.com/gdh1995/vimium-c/blob/master/PRIVACY-POLICY.md",popup:"options.html",privacy:"https://github.com/gdh1995/vimium-c/blob/master/PRIVACY-POLICY.md#privacy-policy",readme:"https://github.com/gdh1995/vimium-c#readme",settings:"options.html",__proto__:null},GlobalCommands:null,ShowPage:"pages/show.html",VomnibarPageInner:"front/vomnibar.html",VomnibarScript:"front/vomnibar.js",VomnibarScript_f:""}},IsEdge=NotChrome&&!!window.StyleMedia,IsFirefox=NotChrome&&!IsEdge&&/\bFirefox\//.test(navigator.userAgent),Backend;Settings.CONST.ChromeVersion=0|(!NotChrome&&navigator.appVersion.match(/\bChrom(?:e|ium)\/(\d+)/)||[0,999])[1];Settings.bufferToLoad.onMac=false;Settings.bufferToLoad.grabFocus=Settings.get("grabBackFocus");Settings.bufferToLoad.browserVer=Settings.CONST.ChromeVersion;chrome.runtime.getPlatformInfo?chrome.runtime.getPlatformInfo(function(e){var t=(e.os||"").toLowerCase(),n=chrome.runtime.PlatformOs;Settings.CONST.Platform=t;Settings.bufferToLoad.onMac=t===(n?n.MAC:"mac")}):Settings.CONST.Platform=IsEdge?"win":"unknown";(function(){function e(e){return(47===e.charCodeAt(0)?n:e.startsWith(r)?"":r)+e}var t=chrome.runtime.getManifest(),n=location.origin,r=n+"/",i=t.chrome_url_overrides,s=t.content_scripts[0].js,o=Settings.CONST,a=Settings.newTabs,l=i&&i.newtab;Settings.defaults.vomnibarPage=o.VomnibarPageInner;NotChrome&&(o.BrowserNewTab2=o.BrowserNewTab);Settings.defaults.newTabUrl=l?o.ChromeInnerNewTab:o.BrowserNewTab;a[o.BrowserNewTab]=a[o.BrowserNewTab2]=1;l&&(a[e(o.VimiumNewTab=l)]=2);o.GlobalCommands=Object.keys(t.commands||{}).map(function(e){return"quickNext"===e?"nextTab":e});o.CurrentVersion=t.version;o.CurrentVersionName=t.version_name||t.version;o.OptionsPage=e(t.options_page||o.OptionsPage);o.AllowClipboardRead=null!=t.permissions&&0<=t.permissions.indexOf("clipboardRead");o.ShowPage=e(o.ShowPage);o.VomnibarPageInner=e(o.VomnibarPageInner);o.VomnibarScript_f=e(o.VomnibarScript);s.push(o.InjectEnd);"startsWith"!=="".startsWith.name&&s.unshift(o.PolyFill);o.ContentScripts=s.map(e);var u="all"in document.documentElement.style;o.StyleCacheId=o.CurrentVersion+","+Settings.CONST.ChromeVersion+(window.ShadowRoot?"s":"")+(u?"a":"")+",";var c=localStorage.getItem("innerCSS");c&&c.startsWith(o.StyleCacheId)?Settings.postUpdate("innerCSS",c):Settings.fetchFile("baseCSS")})();(function(){function l(e,t){var n=e.url,r;n?(r=Settings.newTabs[n])&&(1===r?delete e.url:2===r&&(e.url=Settings.cache.newTabUrl_f)):delete e.url;NotChrome&&delete e.openerTabId;return chrome.tabs.create(e,t)}function u(e,t){var n=e.windowId,r=null!=e.index;l(e,e.active?function(e){null!=n&&e.windowId!==n&&A(e)}:null);if(!(t<2)){e.active=false;do{r&&++e.index;chrome.tabs.create(e)}while(1<--t)}}var m=null,v=null,g=1,p=false,f=0,i=0,b=Object.create(null),c=Settings.CONST.ChromeVersion<41,d=function(e){null==e&&(e="unknown sender");var t=Settings.extWhiteList[e];if(null!=t)return t;console.log("%cReceive message from an extension/sender not in the white list: %c%s","background-color: #fffbe5","background-color:#fffbe5; color: red",e);return Settings.extWhiteList[e]=false},w=function(e){for(var t=e.length;0<--t;)if(e[t].active)return e[t];return e[0]},h=function(e,t){return"before"===t?e.index:"start"===t?0:"end"!==t?e.index+1:void 0},S=function(e,n,r){false===e.focused?"minimized"!==n&&(n="normal"):"minimized"===n&&(n="normal");if(n&&44<=Settings.CONST.ChromeVersion){e.state=n;n=""}var i=false!==e.focused;e.focused=true;chrome.windows.create(e,n||!i?function(e){r&&r(e);if(e){var t=i?{}:{focused:false};n&&(t.state=n);chrome.windows.update(e.id,t)}}:r||null)},o=function(e,t,n){var r="number"==typeof e,i={type:"normal",focused:false,incognito:t,state:"minimized",tabId:r?e:void 0,url:r?void 0:e};if(Settings.CONST.ChromeVersion<44){i.state=void 0;i.left=i.top=0;i.width=i.height=50}chrome.windows.create(i,n)},x=function(){return chrome.runtime.lastError},a=function(t,e,n){if(n){if(0<n.length&&n[0].incognito&&Utils.isRefusingIncognito(t)){l({url:t});Utils.resetRe();return}}else if(Utils.isRefusingIncognito(t)&&true!==e){O(function(e){return a(t,true,e)});return}var r={url:t},i=x;n?chrome.tabs.update(n[0].id,r,i):chrome.tabs.update(r,i);Utils.resetRe()},C=function(e){if(e instanceof Promise)e.then(C);else{Utils.resetRe();switch(e[1]){case"copy":return Backend.showHUD(e[0],true);case"status":return Backend.forceStatus(e[0])}}},s=function(){return 37<=Settings.CONST.ChromeVersion?Backend.complain("control tab sessions"):Backend.showHUD("Vimium C can not control tab sessions before Chrome 37")},I=IsEdge?function(){return false}:function(e,t){var n=e.sender;null==n.isVomnibar&&(n.isVomnibar=n.url===Settings.cache.vomnibarPage_f||n.url===Settings.CONST.VomnibarPageInner);if(n.isVomnibar)return false;if(!t&&!n.warned){console.warn("Receive a request from %can unsafe source page%c (should be vomnibar) :\n %s @ tab %o","color:red","color:auto",n.url,n.tabId);n.warned=true}return true},n=function(e,t,n,r,i){var s=this.sender.url,o=2===e?2:0;if(1==e&&58<=Settings.CONST.ChromeVersion){s=s.substring(0,s.indexOf("/",s.indexOf("://")+3)+1);var a=b;for(var l in a){for(var u=a[l],c=1,d=u.length;c<d;c++){var f=u[c].sender;if(0===f.frameId){f.url.startsWith(s)&&(o=1);break}}if(o)break}}Utils.resetRe();try{this.postMessage({name:"omni",autoSelect:n,matchType:r,list:t,favIcon:o,total:i})}catch(e){}},T=function(e,t){var n=b[e];if(!n)return null;for(var r=1,i=n.length;r<i;r++)if(n[r].sender.frameId===t)return n[r];return null},U=function(e,t){var n=CommandsData.availableCommands[e][0];n=n.replace(/ \(use .*|&nbsp\(.*|<br\/>/,"");return window.confirm("You have asked Vimium C to perform "+t+" repeats of the command:\n        "+Utils.unescapeHTML(n)+"\n\nAre you sure you want to continue?")},t=function(e,t){if(!(null==Exclusions||Exclusions.rules.length<=0||!t&&!Settings.get("exclusionListenHash",true))){e.url=v.sender.url;return Y[e.handler](e,v)}e.name="url";v.postMessage(e)},y=function(e){var t=e.sender;if(4&t.flags)return null;t.flags|=6;return Settings.cache.innerCSS},k=function(e,t){var n=b[e.sender.tabId];if(n&&!(n.indexOf(e)<0)){var r=Settings.cache.innerCSS;r?e.postMessage({name:"showHUD",CSS:r}):t<10&&setTimeout(k,34*t,e,t+1)}},R=function(e,t,n,r,i){n="-"!==n?parseInt(n,10)||1:-1;t&&"object"==typeof t?Object.setPrototypeOf(t,null):t=null;i=+i||0;return G(e,Utils.makeCommand(e,t),n,i,r)},O=chrome.tabs.query.bind(null,{active:true,currentWindow:true}),_=chrome.tabs.query.bind(null,{currentWindow:true}),M=function(e,t){var n=TabRecency.lastWnd;return 0<=n?chrome.windows.get(n,{populate:e},t):chrome.windows.getCurrent({populate:e},t)},L=function(e){var t=b[e?e.sender.tabId:TabRecency.last];return t?t[0]:null},P=function(e,t,n,r,i){var s,o;o=null!=(s=i.filter(function(e){return e.id===r.windowId})[0])&&s.incognito;if(n.window||!(o||0<(i=i.filter(function(e){return e.incognito&&"normal"===e.type})).length))return S({url:e,incognito:true,focused:t},s&&"normal"===s.type?s.state:"");var a={url:e,active:t,windowId:o?r.windowId:i[i.length-1].id};if(o){a.index=h(r,n.position);n.opener&&(a.openerTabId=r.id)}u(a,g);return!o&&t?A(a):void 0},E=[function(t,n,e){if(m.url||m.urls){$.openUrl(e);return chrome.runtime.lastError}var r=null;if(e){if(0<e.length)r=e[0];else if(0<=TabRecency.last){chrome.tabs.get(TabRecency.last,function(e){E[0](t,n,e&&[e])});return chrome.runtime.lastError}}else;if(!r){u({url:t,active:true},g);return chrome.runtime.lastError}r.incognito&&n&&(t="");return u({url:t,active:r.active,windowId:r.windowId,index:h(r,m.position)},g)},function(e){if(m.url||m.urls)return $.openUrl([w(e.tabs)]);if(!e){l({url:this});return chrome.runtime.lastError}var t=w(e.tabs);return e.incognito&&"normal"!==e.type?E[2](this,t,1<g?function(e){for(var t=g;0<--t;)chrome.tabs.duplicate(e)}:null,e.tabs):u({url:this,active:t.active,windowId:"normal"===e.type?t.windowId:void 0,index:h(t,m.position)},g)},function(e,t,n,r){var i=e.toLowerCase().split("#",1)[0];if(0!==(r=r.filter(function(e){var t=e.url.toLowerCase(),n=t.indexOf("#");return(n<0?t:t.substring(0,n))===i})).length){var s=r.filter(function(e){return t.index<=e.index});t=0<s.length?s[0]:r[r.length-1];chrome.tabs.duplicate(t.id);if(n)return n(t.id)}else chrome.windows.getAll(E[3].bind(e,t,n))},function(e,n,t){return 0<(t=t.filter(function(e){return!e.incognito&&"normal"===e.type})).length?E[4](this,e,n,t[0]):o("about:blank",false,E[4].bind(null,this,e,function(e,t){chrome.windows.remove(t);if(n)return n(e)}))},function(e,t,n,r){l({active:false,windowId:r.id,url:e},function(e){return o(e.id,true,E[5].bind(t,n,e))})},function(e,t){chrome.tabs.move(t.id,{index:this.index+1,windowId:this.windowId},function(){e&&e(t.id,t.windowId);return B(t.id)})}],r=function(e,t,n){if("string"==typeof e){var r=m.url_mask;r&&(e=e&&e.replace(r+"",0<n.length?n[0].url:""));(r=m.id_mask||m.id_mark||m.id_marker)&&(e=e&&e.replace(r+"",chrome.runtime.id));9!==t&&(e=Utils.convertToUrl(e+"",m.keyword+"",t))}var i=null==m.reuse?-1:0|m.reuse,s=m;m=null;Utils.resetRe();return"string"!=typeof e?C(e):V[0](e,i,s)?void 0:Utils.isJSUrl(e)?W(e):1===i?Y.focusOrLaunch({url:e}):0===i?a(e):n?H(e,i,s,n):void O(H.bind(null,e,i,s))},N=function(e,t){if(null===t)return Backend.complain("read clipboard");if(!(t=t.trim()))return Backend.showHUD("No text copied!");if(Utils.quotedStringRe.test(t))t=t.slice(1,-1);else{var n=m.keyword;n&&"~"!==n||(t=Utils.detectLinkDeclaration(t))}return r(t,2,e)},H=function(n,e,t,r){var i=r[0],s=!!i&&i.incognito,o=t.incognito,a=-2!==e,l=t.window;if(Utils.isRefusingIncognito(n))(s||1===TabRecency.incognito)&&(l=true);else if(s){if(false!==o)return P(n,a,t,i,[{id:i.windowId,incognito:true}]);l=true}else if(o){chrome.windows.getAll(P.bind(null,n,a,t,i));return}if(!l)return u({url:n,active:a,windowId:i?i.windowId:void 0,openerTabId:t.opener&&i?i.id:void 0,index:i?h(i,t.position):void 0},g);M(false,function(e){var t=e.state;return S({url:n,focused:a},"minimized"!==t&&"docked"!==t?t:"")})},W=function(e){if(v)try{v.postMessage({name:"eval",url:e})}catch(e){}else chrome.tabs.update({url:e},x)},V=[function(t,n,r,e){var i=Settings.CONST.ShowPage;if(!t.startsWith(i)||t.length<i.length+3)return false;if(!e){O(function(e){if(!e||e.length<=0)return chrome.runtime.lastError;V[0](t,n,r,e[0])});return true}t=t.substring(i.length);0!==n||e.incognito?chrome.tabs.create({active:-2!==n,index:e.incognito?void 0:h(e,r.position),windowId:e.incognito?void 0:e.windowId,openerTabId:r.opener?e.id:void 0,url:i}):chrome.tabs.update(e.id,{url:i});var s=[t,null,0];Settings.temp.shownHash=s[1]=function(){clearTimeout(s[2]);Settings.temp.shownHash=null;return s[0]};s[2]=setTimeout(V[1],1200,s);return true},function(e){e[0]="#!url vimium://error (vimium://show: sorry, the info has expired.)";e[2]=setTimeout(function(){Settings.temp.shownHash===e[1]&&(Settings.temp.shownHash=null);e[0]="",e[1]=null},2e3)}],D=function(e){for(var t=e[0],n=t.windowId,r=m.urls,i=g,s=0;s<r.length;s++)r[s]=Utils.convertToUrl(r[s]+"");t.active=!(m.reuse<-1);m=null;do{for(var s=0,o=t.index+1,a=t.active;s<r.length;s++,a=false,o++)l({url:r[s],index:o,windowId:n,active:a})}while(0<--i)},j=function(e,t,n){var r=false,i,s;if((n=n.filter(function(e){return"normal"===e.type})).length<=1){r=true;(s=n[0])&&(s.id!==e.windowId?r=false:s.incognito&&!Utils.isRefusingIncognito(Settings.cache.newTabUrl_f)&&(i=s.id))}else if(!e.incognito&&1===(n=n.filter(function(e){return!e.incognito})).length&&n[0].id===e.windowId){i=n[0].id;r=true}if(r){var o=1<t.length?t.map(function(e){return e.id}):[e.id];l({index:o.length,url:Settings.cache.newTabUrl_f,windowId:i});chrome.tabs.remove(o)}else chrome.windows.remove(e.windowId)},B=function(e,t){chrome.tabs.update(e,{active:true},t?A:null)},A=function(e){e&&chrome.windows.update(e.windowId,{focused:true});return chrome.runtime.lastError},F=function(e,t,n){var r=e.index,i=false;if(0<t)n=n.slice(++r,r+t);else if(t<0){i=0<r&&!n[r-1].pinned;n=n.slice(Math.max(r+t,0),r)}else{i=!e.pinned&&1<n.length;n.splice(r,1)}i&&n[0].pinned&&(n=n.filter(function(e){return!e.pinned}));0<n.length&&chrome.tabs.remove(n.map(function(e){return e.id}),x)},q=[function(e){1!==TabRecency.incognito&&e&&(e=e.filter(function(e){return!e.incognito}));if(!(e&&0<e.length)){O(q[1].bind(this));return chrome.runtime.lastError}M(false,q[2].bind(this,e))},function(e){var t=this.scroll?q[3].bind(this,0):null;e.length<=0||1===TabRecency.incognito&&!e[0].incognito?chrome.windows.create({url:this.url},t&&function(e){if(e.tabs&&0<e.tabs.length)return t(e.tabs[0])}):l({index:e[0].index+1,url:this.url,windowId:e[0].windowId},t)},function(e,t){var n=t.id,r=this.url,i=e.filter(function(e){return e.windowId===n});if(i.length<=0&&(i=t.incognito?e:e.filter(function(e){return!e.incognito})).length<=0)O(q[1].bind(this));else{this.prefix&&i.sort(function(e,t){return e.url.length-t.url.length});var s=w(i);i[0].url.length<s.url.length&&(s=i[0]);chrome.tabs.update(s.id,{url:s.url===r||s.url.startsWith(r)?void 0:r,active:true},this.scroll?q[3].bind(this,0):null);if(s.windowId!==n)return A(s)}},function(e,t){var n=this;if(!t)return chrome.runtime.lastError;if("complete"===t.status||2<=e)return Marks.scrollTab(this,t);setTimeout(function(){chrome.tabs.get(t.id,q[3].bind(n,e+1))},800)}],z=function(e,t){if(i){clearTimeout(i);i=0}if(!t)return R(e,CommandsData.cmdMap[e]||null,1,null);i=setTimeout(z,100,e,null);t[0].postMessage({name:"count",cmd:e,id:i})},$={createTab:function(){},duplicateTab:function(){function r(e){return u({url:e.url,active:false,windowId:e.windowId,pinned:e.pinned,index:e.index+2,openerTabId:e.id},g-1)}var i=v.sender.tabId;if(i<0)return Backend.complain("duplicate such a tab");chrome.tabs.duplicate(i);g<2||(52<=Settings.CONST.ChromeVersion||-1===TabRecency.incognito?chrome.tabs.get(i,r):chrome.windows.getCurrent({populate:true},function(e){var t=e.tabs.filter(function(e){return e.id===i})[0];if(!e.incognito||t.incognito)return r(t);for(var n=g;0<--n;)chrome.tabs.duplicate(i)}))},moveTabToNewWindow:function(){function e(d){var e=d.tabs.length;if(!(e<=1)){var t=w(d.tabs),f=t.index,n=g,r=Math.abs(n),i,h=Math.min(r,(null!=m.limited?!!m.limited:e<r)?n<0?f+1:e-f:e);if(e<=h)return Backend.showHUD("It does nothing to move all tabs of this window");if(!(30<h)||U("moveTabToNewWindow",h)){n<0&&(h=-h);return S({tabId:t.id,incognito:t.incognito},"normal"===d.type?d.state:"",1<r?function(e){var t=d.tabs,n,r=t[f],i=t.length,s=f+h;(i<s||s<-1)&&(n=0<h?t.slice(i-h,f):t.slice(f+1,-h));t=0<h?t.slice(f+1,s):t.slice(Math.max(0,s+1),f);if(d.incognito&&Settings.CONST.ChromeVersion<52){var o=r.incognito,a=function(e){return e.incognito===o};t=t.filter(a);n&&(n=n.filter(a))}if(h<0){var l=n;n=t;t=l}var u=0,c=function(e){return e.id};if(n&&0<n.length){chrome.tabs.move(n.map(c),{index:0,windowId:e.id},x);1<(u=n.length)&&chrome.tabs.move(r.id,{index:u})}t&&0<t.length&&chrome.tabs.move(t.map(c),{index:u+1,windowId:e.id},x)}:null)}}}function n(){return Backend.showHUD("This tab has been in an incognito window")}function t(r){var e=w(r.tabs);if(r.incognito&&e.incognito)return n();var i={tabId:e.id,incognito:true},t=e.url;if(e.incognito);else if(Utils.isRefusingIncognito(t)){if(r.incognito)return n();if(52<=Settings.CONST.ChromeVersion||Settings.CONST.DisallowIncognito)return Backend.complain("open this URL in incognito mode")}else{if(r.incognito){++e.index;return Backend.reopenTab(e)}i.url=t}r.tabs=void 0;chrome.windows.getAll(function(e){var t;if((e=e.filter(function(e){return e.incognito&&"normal"===e.type})).length)chrome.tabs.query({windowId:e[e.length-1].id,active:true},function(e){var t=e[0],n=i.tabId;if(!i.url)return o(n,true,function(){chrome.tabs.move(n,{index:t.index+1,windowId:t.windowId},function(){return B(n,true)})});chrome.tabs.create({url:i.url,index:t.index+1,windowId:t.windowId});A(t);chrome.tabs.remove(n)});else{var n="normal"===r.type?r.state:"";if(i.url){t=i.tabId;i.tabId=void 0;if(Settings.CONST.DisallowIncognito){i.focused=true;n=""}}S(i,n);null!=t&&chrome.tabs.remove(t)}})}var r=!!m.incognito;if(r&&(v?v.sender.incognito:1===TabRecency.incognito))return n();chrome.windows.getCurrent({populate:true},r?t:e)},moveTabToNextWindow:function(e){var s=e[0];chrome.windows.getAll(function(e){var t,n,r=s.windowId;if(0<(t=e.filter(function(e){return e.incognito===s.incognito&&"normal"===e.type})).length){n=t.map(function(e){return e.id});r=n.indexOf(r);if(2<=n.length||-1===r){var i=(r+g)%n.length;-1===r&&g<0&&i++;i<0&&(i+=n.length);chrome.tabs.query({windowId:n[i],active:true},function(e){function t(){chrome.tabs.move(s.id,{index:n.index+1,windowId:n.windowId},function(){return B(s.id,true)})}var n=e[0];return 0<=r?t():o(s.id,s.incognito,t)});return}}else t=e.filter(function(e){return e.id===r});return S({tabId:s.id,incognito:s.incognito},1===t.length&&"normal"===t[0].type?t[0].state:"")})},toggleCS:function(e){return ContentSettings.toggleCS(g,m,e)},clearCS:function(){return ContentSettings.clearCS(m,v)},goTab:function(e){if(!(e.length<2)){var t=(0|m.dir||1)*g,n=e.length,r;return(r=e[(0<=(t=m.absolute?0<t?Math.min(n,t)-1:Math.max(0,n+t):Math.abs(g)>2*e.length?0<t?-1:0:w(e).index+t)?0:n)+t%n]).active?void 0:B(r.id)}},removeTab:function(e){if(!e||e.length<=0)return chrome.runtime.lastError;var t=e.length,n=g,r=Math.abs(n),i=null!=m.limited?!!m.limited:t<r,s=e[0];if(true===m.allow_close);else if(t<=r&&(s.active||!i&&(!s.pinned||w(e).pinned))){chrome.windows.getAll(j.bind(null,s,e));return}s.active||(s=w(e));var o=s.index,a=m.left,l=n<0,u=l?o+1:t-o,c=Math.min(r,i?u:t);if(!(20<c)||U("removeTab",c)){chrome.tabs.remove(s.id,x);if(c<=1)a&&0<o&&chrome.tabs.update(e[o-1].id,{active:true});else{var d=0<o&&e[o-1].pinned&&!s.pinned,f=l?-1:1;l&&d||F(s,f*(c-1),e);if(!(c<=u||!l&&d))return F(s,f*(u-c),e);a&&c<u&&0<o&&chrome.tabs.update(e[o-1].id,{active:true})}}},removeTabsR:function(e){var t=0|m.dir;t=0<t?1:t<0?-1:0;return F(w(e),t*g,e)},removeRightTab:function(e){var t=e.length-1,n=g;if(!(!e||t<n||n<-t)){var r=w(e).index+n;chrome.tabs.remove(e[t<r?t-n:r<0?-n:r].id)}},restoreTab:function(){if(!chrome.sessions)return s();var e=g;if(e<2&&-2<e&&v.sender.incognito)return Backend.showHUD("Can not restore a tab in incognito mode!");var t=0|chrome.sessions.MAX_SESSION_RESULTS;t<e&&0<t&&(e=t);for(;chrome.sessions.restore(null,x),0<--e;);},restoreGivenTab:function(){function e(e){if(e.length<g)return Backend.showHUD("The session index provided is out of range.");var t=e[g-1],n=t.tab||t.window;n&&chrome.sessions.restore(n.sessionId)}if(!chrome.sessions)return s();if(g>(chrome.sessions.MAX_SESSION_RESULTS||25))return e([]);g<=1?chrome.sessions.restore(null,x):chrome.sessions.getRecentlyClosed(e)},blank:function(){},openUrl:function(e){if(!m.urls){if(m.url_mask&&!e)return chrome.runtime.lastError||void O($.openUrl);var t,n=9;if(t=m.url){t+="";n=0}else{if(m.copied){if((t=VClipboard.paste())instanceof Promise){t.then(N.bind(null,e),N.bind(null,null,null));return}return N(e,t)}t=m.url_f||""}return r(t,n,e)}if(m.urls instanceof Array)return e&&0<e.length?D(e):void O(D);m=null},searchInAnother:function(e){var t=(m.keyword||"")+"",n=Backend.parse({url:e[0].url});if(n&&t){var r=Utils.createSearchUrl(n.url.split(" "),t,2);m=Object.setPrototypeOf({reuse:0|m.reuse,opener:true,url_f:r},null);$.openUrl(e)}else Backend.showHUD(t?"No search engine found!":'This key mapping lacks an arg "keyword"')},togglePinTab:function(e){var t=w(e),n=t.index,r=Math.max(-1,Math.min(n+g,e.length)),i=n<r?1:-1,s=!t.pinned,o={pinned:s};if(n<r!==s){n=r-i;r=t.index-i;i=-i}do{chrome.tabs.update(e[n].id,o);n+=i}while(r!=n&&n<e.length&&0<=n&&(s||e[n].pinned))},toggleMuteTab:function(){if(Settings.CONST.ChromeVersion<45)return Backend.showHUD("Vimium C can not control mute state before Chrome 45");m.all||m.other?chrome.tabs.query({audible:true},function(e){for(var t=m.other?v.sender.tabId:-1,n=false,r={muted:true},i=e.length;0<=--i;){var s=e[i];if(s.id!==t&&!s.mutedInfo.muted){n=true;chrome.tabs.update(s.id,r)}}if(!n){r.muted=false;for(var i=e.length;0<=--i;){var o=e[i].id;o!==t&&chrome.tabs.update(o,r)}}}):O(function(e){var t=e[0];chrome.tabs.update(t.id,{muted:!t.mutedInfo.muted})})},reloadTab:function(e){if(e.length<=0)M(true,function(e){if(!e)return chrome.runtime.lastError;0<e.tabs.length&&$.reloadTab(e.tabs)});else{var t={bypassCache:true===(m.hard||m.bypassCache)},n=w(e).index,r=e.length,i=r-1,s=g,o=0<g?1:-1,a=n+g-o;if(m.single)a=(n=i<a?r<g?0:r-g:a<0?g<-r?i:o-g:a)+o;else if(i<a)g<=(a=r)&&(n=r-g);else if(a<0){a=o;-r<=g&&(n=o-g)}else a+=o;do{chrome.tabs.reload(e[n].id,t);n+=o}while(a!=n&&n<r&&0<=n)}},reloadGivenTab:function(){g<2&&-2<g?chrome.tabs.reload():_($.reloadTab)},reopenTab:function(e){if(!(e.length<=0)){var t=e[0];++t.index;if(52<=Settings.CONST.ChromeVersion||Settings.CONST.DisallowIncognito||-1===TabRecency.incognito||!Utils.isRefusingIncognito(t.url))return Backend.reopenTab(t);chrome.windows.get(t.windowId,function(e){e.incognito&&!t.incognito&&(t.openerTabId=t.windowId=void 0);return Backend.reopenTab(t)})}},goToRoot:function(e){var t=m.trailing_slash,n=Y.parseUpperUrl({trailing_slash:null!=t?!!t:null,url:e[0].url,upper:g}),r,i=n.url;if(null==n.path)return Backend.showHUD(i);chrome.tabs.update(e[0].id,{url:i})},goUp:function(){var e=m.trailing_slash;return t({handler:"parseUpperUrl",upper:-g,trailing_slash:null!=e?!!e:null,execute:true})},moveTab:function(e){for(var t=w(e),n=0<m.dir?1:-1,r=t.pinned,i=Math.max(0,Math.min(e.length-1,t.index+n*g));r!==e[i].pinned;)i-=n;i!=t.index&&chrome.tabs.move(t.id,{index:i})},nextFrame:function(){var e=v,t=-1,n=b[e.sender.tabId];if(n&&2<n.length){t=Math.max(0,n.indexOf(e,1));for(var r=Math.abs(g),i=0<g?1:-1;0<r;r--)(t+=i)===n.length?t=1:t<1&&(t=n.length-1);e=n[t]}e.postMessage({name:"focusFrame",CSS:0!==e.sender.frameId&&4&e.sender.flags?null:y(e),key:f,mask:e!==v?2:1})},mainFrame:function(){var e=v?v.sender.tabId:TabRecency.last,t=T(e,0);t&&t.postMessage({name:"focusFrame",CSS:y(t),key:f,mask:b[e][0]===t?1:3})},parentFrame:function(){var l=v.sender,e=c?"Vimium C can not know parent frame before Chrome 41":l&&0<=l.tabId&&b[l.tabId]?null:"Vimium C can not access frames in current tab";e&&Backend.showHUD(e);if(!l||!l.frameId||c||!chrome.webNavigation)return $.mainFrame();chrome.webNavigation.getAllFrames({tabId:l.tabId},function(e){var t=l.frameId,n,r=g;do{n=false;for(var i=0,s=e;i<s.length;i++){var o=s[i];if(o.frameId===t){n=0<(t=o.parentFrameId);break}}}while(n&&0<--r);var a=0<t?T(l.tabId,t):null;if(!a)return $.mainFrame();a.postMessage({name:"focusFrame",CSS:y(a),key:f,mask:3})})},visitPreviousTab:function(e){if(!(e.length<2)){e.splice(w(e).index,1);var t=(e=e.filter(function(e){return e.id in TabRecency.tabs}).sort(TabRecency.rCompare))[0<g?Math.min(g,e.length)-1:Math.max(0,e.length+g)];t&&B(t.id)}},copyTabInfo:function(e){var t,n=!!(m.decoded||m.decode);switch(m.type){case"title":t=e[0].title;break;case"frame":if(p&&(t=v.sender.url))break;v.postMessage({name:"execute",CSS:y(v),command:"autoCopy",count:1,options:{url:true,decoded:n}});return;default:t=e[0].url}n&&(t=Utils.DecodeURLPart(t,decodeURI));VClipboard.copy(t);return Backend.showHUD(t,true)},goNext:function(){var e=m.rel||m.dir,t=[],n=m.patterns;e=e?e+"":"next";if(n instanceof Array)for(var r=0,i=n;r<i.length;r++){var s;(s=(s=i[r])&&(s+"").trim())&&t.push(s.toLowerCase())}else{"string"==typeof n||(n="");for(var o=0,a=n=(n=n||Settings.get("next"!==e?"previousPatterns":"nextPatterns",true)).trim().toLowerCase().split(",");o<a.length;o++){var s;(s=(s=a[o]).trim())&&t.push(s)}}200<t.length&&(t.length=200);v.postMessage({name:"execute",count:1,command:"goNext",CSS:null,options:{rel:e,patterns:t}})},enterInsertMode:function(){var e=0|m.code,t=0|m.stat,n;e=0!==t?e||27:27===e?0:e;n=null!=m.hideHUD?!m.hideHUD:null!=m.hideHud?!m.hideHud:!Settings.get("hideHud",true);v.postMessage({name:"execute",count:1,command:"enterInsertMode",CSS:n?y(v):null,options:{code:e,stat:t,passExitKey:!!m.passExitKey,hud:n}})},performFind:function(){var e=!m.active,t=e||m.last?FindModeHistory.query(v.sender.incognito):"";v.postMessage({name:"execute",count:1,command:"Find.activate",CSS:y(v),options:{count:m.dir<=0?-g:g,leave:e,query:t}})},showVomnibar:function(e){var t=v;if(t)0!==t.sender.frameId&&0<=t.sender.tabId&&(t=T(t.sender.tabId,0)||t);else if(!(t=v=T(TabRecency.last,0)))return;var n=Settings.cache.vomnibarPage_f,r=t.sender.url,i=!n.startsWith("chrome"),s=e||!n.startsWith(location.origin)?Settings.CONST.VomnibarPageInner:n,o=(e=(i?r.startsWith("chrome")||n.startsWith("file:")&&!r.startsWith("file:")||n.startsWith("http:")&&r.startsWith("https:"):t.sender.incognito)||r.startsWith(location.origin)||!!e)||n===s||t.sender.tabId<0,a=Utils.extendIf(Object.setPrototypeOf({vomnibar:o?s:n,vomnibar2:o?null:s,ptype:o?0:i?2:1,script:o?"":Settings.CONST.VomnibarScript_f,secret:X(),CSS:y(t)},null),m);t.postMessage({name:"execute",count:g,CSS:null,command:"Vomnibar.activate",options:a});a.secret=-1;m=a},clearFindHistory:function(){var e=v.sender.incognito;FindModeHistory.removeAll(e);return Backend.showHUD((e?"incognito ":"")+"find history has been cleared.")},showHelp:function(){if(0===v.sender.frameId&&!(window.HelpDialog&&8&v.sender.flags))return Y.initHelp({},v);window.HelpDialog||Utils.require("HelpDialog");v.postMessage({name:"execute",command:"showHelp",count:1,options:null,CSS:null})},toggleViewSource:function(e){var t=e[0],n=t.url;if(n.startsWith("chrome"))return Backend.complain("visit HTML of an extension's page");l({url:n=n.startsWith("view-source:")?n.substring(12):"view-source:"+n,active:t.active,windowId:t.windowId,index:t.index+1,openerTabId:t.id})},clearMarks:function(){return m.local?t({handler:"marks",action:"clear"},true):Marks.clear()}},K=/^-?\d+|^-/,G=function(e,t,n,r,i){var s=t.options,o=t.repeat,a=t.alias,l=t.background,u;s&&(u=s.count)&&(n*=u);if(1===(n=1e4<=n?9999:n<=-1e4?9999:0|n||1));else if(1===o)n=1;else{if(0<o&&(o<n||n<-o)&&!U(e,Math.abs(n)))return;n=n||1}if(l){var c=$[a];m=s||Object.create(null);v=i;g=n;f=r;if((n=c.useTab)<1)return c();1===n?O(c):_(c)}else{var d=a.indexOf(".");e=0===d?a.substring(1)||e:a;i.postMessage({name:"execute",command:e,CSS:0<=d?y(i):null,count:n,options:s})}},Y={blank:function(){},setSetting:function(e,t){var n=e.key;if(!(n in Settings.frontUpdateAllowed)){v=t;return Backend.complain("modify "+n+" setting")}Settings.set(n,e.value);n in Settings.bufferToLoad&&(Settings.bufferToLoad[n]=Settings.cache[n])},findQuery:function(e,t){return FindModeHistory.query(t.sender.incognito,e.query,e.index)},parseSearchUrl:function(e,t){var n=Backend.parse(e);if(!("id"in e))return n;t.postMessage({name:"parsed",id:e.id,search:n})},parseUpperUrl:function(e,t){if(t&&e.execute){var n=Y.parseUpperUrl(e);if(null!=n.path){t.postMessage({name:"execute",command:"reload",count:1,options:{url:n.url},CSS:null});return}v=t;return Backend.showHUD(n.url)}var r=e.url,i=r.toLowerCase();if(!Utils.protocolRe.test(Utils.removeComposedScheme(i))){Utils.resetRe();return{url:"This url has no upper paths",path:null}}var s="",o,a,l=false,u=false,c=null,d,f=0,h=0,m=false,g;if(d=r.lastIndexOf("#")+1){s=r.substring(d+ +("!"===r[d]));if(0<(d=(o=Utils.DecodeURLPart(s)).lastIndexOf("/"))||0===d&&1<o.length){m=o!==s;var p=/([^&=]+=)([^&\/=]*\/[^&]*)/;if("/"===(c=(a=p.exec(o)||/(^|&)([^&\/=]*\/[^&=]*)(?:&|$)/.exec(o))?a[2]:o)||0<=c.indexOf("://"))c=null;else if(a)if(m){o="https://example.com/";o=encodeURI(o+c).substring(o.length);(d=s.indexOf(o))<0&&(d=s.indexOf(o=encodeURIComponent(c)));if(d<0){m=false;d=s.indexOf(o=c)}h=d+o.length;if(d<0&&"&"!==a[1]){if((d=s.indexOf(o=a[1]))<0){m=true;o=a[1];o=encodeURIComponent(o.substring(0,o.length-1));d=s.indexOf(o)}0<=d&&(h=s.indexOf("&",d+=o.length)+1)}if(0<=d)f=d;else if(g=p.exec(s)){c=Utils.DecodeURLPart(g[2]);h=(f=g.index+g[1].length)+g[2].length}else if("&"!==(o=a[1])){d=r.length-s.length;s=o+encodeURIComponent(c);r=r.substring(0,d)+s;f=o.length;h=0}}else f=a.index+a[1].length;else f=0;if(c){f+=d=r.length-s.length;0<h&&(h+=d)}}}if(!c){if(i.startsWith("chrome")){Utils.resetRe();return{url:"An extension has no upper-level pages",path:null}}s="";f=r.indexOf("/",r.indexOf("://")+3);i.startsWith("filesystem:")&&(f=r.indexOf("/",f+1));d=r.indexOf("?",f);h=r.indexOf("#",f);c=r.substring(f,d=0<(d=h<0?d:d<0?h:d<h?d:h)?d:r.length);h=0;m=false}d=e.upper;l=c.startsWith("/");if(!s&&i.startsWith("file:")){if(c.length<=1||11===r.length&&r.endsWith(":/")){Utils.resetRe();return{url:"This has been the root path",path:null}}u=true;1===d&&(d=-1)}else u=!(s||!i.startsWith("ftp:"))||(null!=e.trailing_slash?!!e.trailing_slash:1<c.length&&c.endsWith("/"));if(d&&1!==d){var b=c.substring(+l,c.length-+c.endsWith("/")||+l).split("/");d<0&&(d+=b.length);if(d<=0)c="/";else if(0<d&&d<b.length){b.length=d;c=(l?"/":"")+(c=b.join("/"))+(u?"/":"")}}else c="/";o=m?encodeURIComponent(c):c;r=r.substring(0,f)+(h?o+r.substring(h):o);Utils.resetRe();return{url:r,path:c}},searchAs:function(e,n){function t(e){var t=null===e?"It's not allowed to read clipboard":(e=e.trim())?"":"No selected or copied text found";if(t){v=n;return Backend.showHUD(t)}e=Utils.createSearchUrl(e.split(Utils.spacesRe),r.keyword);return a(e)}var r=Backend.parse(e),i;if(!r||!r.keyword){v=n;return Backend.showHUD("No search engine found!")}if(!((i=e.search.trim()||VClipboard.paste())instanceof Promise))return t(i);i.then(t,function(){return t(null)})},gotoSession:function(e,t){var n=e.sessionId,r=false!==e.active;if("number"==typeof n)return B(n,true);if(!chrome.sessions){v=L(t);return s()}chrome.sessions.restore(n,x);if(!r){var i=t.sender.tabId;0<=i||(i=TabRecency.last);return 0<=i?B(i):void 0}},openUrl:function(e,t){Object.setPrototypeOf(e,null);var n=null!=t&&I(t,true);v=n?t:L(t)||v;var r=e.url;if(r){":"===r[0]&&e.omni&&/^:[bdhost]\s/.test(r)&&((r=r.substring(2).trim())||(n=false));r=Utils.convertToUrl(r,e.keyword||null,n?-1:2);var i=Utils.lastUrlType;null==e.https||2!==i&&1!==i?n&&3===i&&r.startsWith("vimium:")&&(r=Utils.convertToUrl(r)):r=(e.https?"https":"http")+r.substring("s"===r[4]?5:4);e.url="";e.keyword="";e.url_f=r;e.opener=n}else e.opener=false;g=1;m=e;return $.openUrl()},focus:function(e,t){var n=t.sender.tabId,r=b[n],i;if(!r)return p?Backend.setIcon(n,t.sender.status):void 0;if(t!==r[0]){if(p&&(i=t.sender.status)!==r[0].sender.status){r[0]=t;return Backend.setIcon(n,i)}r[0]=t}},checkIfEnabled:function(e,t){if(t&&t.postMessage||(t=T(e.tabId,e.frameId))){var n=t.sender,r=n.url,i=n.tabId,s=Backend.getExcluded(n.url=e.url),o=null===s?0:s?1:2;if(n.status!==o){if(1&n.flags)return;n.status=o;p&&b[i][0]===t&&Backend.setIcon(i,o)}else if(!s||s===Backend.getExcluded(r))return;t.postMessage({name:"reset",passKeys:s})}},nextFrame:function(e,t){v=t;g=1;f=e.key;var n=e.type||0;if(2!==n)return 1===n?$.parentFrame():$.nextFrame();var r=b[t.sender.tabId];if(r)r[0].postMessage({name:"focusFrame",key:f,mask:0});else try{t.postMessage({name:"returnFocus",key:f})}catch(e){}},exitGrab:function(e,t){var n=b[t.sender.tabId];if(n){n[0].sender.flags|=2;if(!(n.length<3))for(var r={name:"exitGrab"},i=n.length;0<--i;){var s=n[i];if(s!==t){s.postMessage(r);s.sender.flags|=2}}}},execInChild:function(e,t){var n=b[t.sender.tabId],r=e.url;if(!n||n.length<3)return false;for(var i=null,s=n.length;1<=--s;)if(n[s].sender.url===r){if(i)return false;i=n[s]}if(i){i.postMessage({CSS:e.CSS?y(i):null,name:"execute",command:e.command,count:e.count||1,options:e.options});return true}return false},initHelp:function(e,t){if(t.sender.url.startsWith(Settings.CONST.OptionsPage)){e.unbound=true;e.names=true}Promise.all([Utils.require("HelpDialog"),e,t,new Promise(function(e,t){var n=Settings.fetchFile("helpDialog",e);n instanceof XMLHttpRequest&&(n.onerror=t)})]).then(function(e){var t=e[1].wantTop&&T(e[2].sender.tabId,0)||e[2];t.sender.flags|=8;t.postMessage({name:"showHelpDialog",CSS:y(t),html:e[0].render(e[1]),optionUrl:Settings.CONST.OptionsPage,advanced:Settings.get("showAdvancedCommands",true)})},function(e){console.error("Promises for initHelp failed:",e[0],";",e[3])})},css:function(e,t){var n=y(t);n?t.postMessage({name:"showHUD",CSS:n}):Settings.cache.innerCSS||setTimeout(k,34,t,1)},activateVomnibar:function(e,t){var n=e.count,r=e.inner;if(null!=n){delete e.count,delete e.handler,delete e.inner;g=+n||1;m=Object.setPrototypeOf(e,null)}else{if(true!==e.redo)return;if(null==m||-1!==m.secret){if(r)return;m=Object.create(null);g=1}else if(r&&m.vomnibar===Settings.CONST.VomnibarPageInner)return}v=t;return $.showVomnibar(r)},omni:function(e,t){if(!I(t))return Completion.filter(e.query,e,n.bind(t,0|e.favIcon))},copy:function(e){VClipboard.copy(e.data)},key:function(e,t){t.sender.flags|=2;var n=e.key,r=1,i=K.exec(n);if(null!=i){var s=i[0];n=n.substring(s.length);r="-"!==s?parseInt(s,10)||1:-1}var o=CommandsData.keyToCommandRegistry;if(!(n in o)){n=(i=n.match(Utils.keyRe))[i.length-1];r=1}var a=o[n];Utils.resetRe();return G(a.command,a,r,e.lastKey,t)},marks:function(e,t){v=t;switch(e.action){case"create":return Marks.createMark(e,t);case"goto":return Marks.gotoMark(e,t);case"clear":return Marks.clear(e.url);default:return}},focusOrLaunch:function(t,e,n){var r=Utils.reformatURL(t.url.split("#",1)[0]),i=q[0],s;if(r.startsWith("file:")&&!n&&r.substring(r.lastIndexOf("/")+1).indexOf(".")<0){r+="/";s=function(e){return e&&0<e.length?i.call(t,e):Y.focusOrLaunch(t,null,true)}}else{t.prefix&&(r+="*");s=i.bind(t)}chrome.tabs.query({url:r,windowType:"normal"},s)},cmd:function(e,t){var n=e.cmd,r=e.id;if(!r||i===r){if(i){clearTimeout(i);i=0}R(n,CommandsData.cmdMap[n]||null,e.count,t)}},blurTest:function(e,t){t.sender.tabId<0?t.postMessage({name:"blurred"}):setTimeout(function(){t.sender.tabId===TabRecency.last&&0<=J.framesForOmni.indexOf(t)&&t.postMessage({name:"blurred"})},50)},removeSug:function(e,t){return Backend.removeSug(e,t)}},J={_fakeId:-2,framesForOmni:[null],OnMessage:function(e,t){var n;if(!(n=e._msgId))return Y[e.handler](e,t);t.postMessage({_msgId:n,response:Y[(e=e.request).handler](e,t)})},OnConnect:function(e){var t=0|e.name.substring(9),n=J.format(e),r=n.tabId,i=n.url,s,o=b[r];if(8<=t||i===Settings.cache.vomnibarPage_f)if(t<16){if(J.onOmniConnect(e,r,t))return;s=0;n.flags=2}else{s=(t>>>4&3)-1;n.flags=(128&t?3:2)+(64&t&&4)}else{var a=void 0,l=0;o&&1&(l=n.flags=3&o[0].sender.flags)?a=2!==(s=o[0].sender.status)?null:"":s=null===(a=Backend.getExcluded(i))?0:a?1:2;e.postMessage({name:"init",flags:l,load:Settings.bufferToLoad,passKeys:a,mapKeys:CommandsData.mapKeyRegistry,keyMap:CommandsData.keyMap})}n.status=s;e.onDisconnect.addListener(J.OnDisconnect);e.onMessage.addListener(J.OnMessage);if(o){o.push(e);if(2&t){p&&o[0].sender.status!==s&&Backend.setIcon(r,s);o[0]=e}}else{b[r]=[e,e];0!==s&&p&&Backend.setIcon(r,s)}c&&(n.frameId=4&t?0:2+(9999997*Math.random()|0))},OnDisconnect:function(e){var t=e.sender.tabId,n,r=b[t];if(r){n=r.lastIndexOf(e);if(e.sender.frameId){n===r.length-1?--r.length:1<=n&&r.splice(n,1);r.length<=1?delete b[t]:e===r[0]&&(r[0]=r[1])}else 0<=n&&delete b[t]}},onOmniConnect:function(e,t,n){if(8<=n){if(!I(e)){this.framesForOmni.push(e);t<0&&(e.sender.tabId=8!==n?this._fakeId--:v?v.sender.tabId:TabRecency.last);e.onDisconnect.addListener(this.OnOmniDisconnect);e.onMessage.addListener(this.OnMessage);e.postMessage({name:"secret",browserVersion:Settings.CONST.ChromeVersion,secret:X()});return true}}else if(!(t<0||Settings.CONST.ChromeVersion<50||0===e.sender.frameId)){chrome.tabs.executeScript(t,{file:Settings.CONST.VomnibarScript,frameId:e.sender.frameId,runAt:"document_start"});e.disconnect();return true}return false},OnOmniDisconnect:function(e){var t=J.framesForOmni,n=t.lastIndexOf(e);n===t.length-1?--t.length:0<=n&&t.splice(n,1)},format:function(e){var t=e.sender,n=t.tab||{id:this._fakeId--,url:"",incognito:false};return e.sender={frameId:t.frameId||0,incognito:n.incognito,status:0,flags:0,tabId:n.id,url:t.url||n.url||""}}},X=(function(){var t=0,n=0;return function(){var e=Date.now();3e3<e-n&&(t=1+(0|1879048191*Math.random()));n=e;return t}})();Backend={gotoSession:Y.gotoSession,openUrl:Y.openUrl,checkIfEnabled:Y.checkIfEnabled,focus:Y.focusOrLaunch,getExcluded:Utils.getNull,IconBuffer:null,removeSug:function(e,t){var n=e.type,r=e.url,i="tab"===n?n:n+" item";v=L(t);return"tab"===n&&TabRecency.last===+r?Backend.showHUD("The current tab should be kept."):Completion.removeSug(r,n,function(e){return Backend.showHUD(e?"Succeed to delete a "+i:"The "+i+" is not found!")})},setIcon:function(){},complain:function(e){return this.showHUD("It's not allowed to "+e)},parse:function(e){var t=e.url,n=t.toLowerCase(),r,i=null,s,o=false;if(!Utils.protocolRe.test(Utils.removeComposedScheme(n))){Utils.resetRe();return null}if(e.upper){var a=Y.parseUpperUrl(e);null!=a.path&&(t=a.url);return{keyword:"",start:0,url:t}}var l=Settings.cache.searchEngineRules;if(s=Utils.IsURLHttp(n)){n=n.substring(s);t=t.substring(s)}for(s=l.length;0<=--s&&(!n.startsWith((r=l[s]).prefix)||!(i=t.substring(r.prefix.length).match(r.matcher))););if(!i||!r){Utils.resetRe();return null}1<i.length&&!r.matcher.global&&i.shift();var u=r.delimiter;if(1<i.length)o=true;else if(u instanceof RegExp)if(i=(n=i[0]).match(u)){i.shift();o=true}else i=[n];else i=i[0].split(u);n="";for(s=0;s<i.length;s++)n+=" "+Utils.DecodeURLPart(i[s]);n=n.trim().replace(Utils.spacesRe," ");Utils.resetRe();return{keyword:r.name,url:n,start:o?n.lastIndexOf(" ")+1:0}},reopenTab:function(e,t){if(t){chrome.tabs.remove(e.id,x);var n=0,r=e.id,i=function(){var e=chrome.runtime.lastError;if(e){chrome.sessions.restore();return e}5<=(n+=1)||setTimeout(function(){chrome.tabs.get(r,i)},50*n*n)};chrome.tabs.get(r,i)}else{l({windowId:e.windowId,index:e.index,url:e.url,active:e.active,pinned:e.pinned,openerTabId:e.openerTabId});chrome.tabs.remove(e.id)}},showHUD:function(e,t){try{v&&v.postMessage({name:"showHUD",CSS:y(v),text:e,isCopy:true===t})}catch(e){v=null}},forceStatus:function(e,t){var n=b[t||(t=TabRecency.last)];if(n){e=e.toLowerCase();var r=null==Exclusions||Exclusions.rules.length<=0,i=n[0].sender.status,s="enable"===e?0:"disable"===e?2:"toggle"===e?2===i?0:2:null,o=null!==s,a=!(o||r),l={name:"reset",passKeys:2!==s?null:"",forced:o};v=T(t,0)||n[0];if(!(null==s&&t<0)){for(var u,c=o?s:0,d=n.length;1<=--d;){var f=n[d],h=f.sender;h.flags=o?1|h.flags:-2&h.flags;if(!a||1==(c=null===(u=l.passKeys=this.getExcluded(h.url))?0:u?1:2)||h.status!==c){h.status=c;f.postMessage(l)}}2!==c&&this.showHUD("Now the page status is "+(0===c?"enabled":"partially disabled"));return p&&(c=n[0].sender.status)!==i?this.setIcon(t,c):void 0}2!==i&&this.showHUD("Got an unknown action on status: "+e)}},ExecuteGlobal:function(t){var e=TabRecency.last,n=b[e];"quickNext"===t&&(t="nextTab");if(null==n||2&n[0].sender.flags)return z(t,n);n&&(n[0].sender.flags|=2);chrome.tabs.get(e,function(e){z(t,e&&"complete"===e.status?b[e.id]:null);return chrome.runtime.lastError})},indexPorts:function(e,t){return null==e?b:null==t?b[e]||null:T(e,t)},onInit:function(){Backend.onInit=null;chrome.runtime.onConnect.addListener(J.OnConnect);if(chrome.runtime.onConnectExternal){Settings.extWhiteList||Settings.postUpdate("extWhiteList");chrome.runtime.onConnectExternal.addListener(function(e){if(e.sender&&d(e.sender.id)&&(e.name.startsWith("vimium-c")||e.name.startsWith("vimium++")))return J.OnConnect(e);e.disconnect()})}}};52<=Settings.CONST.ChromeVersion&&(E.length=1);Settings.updateHooks.newTabUrl_f=function(e){var t=Utils.isRefusingIncognito(e),n=1<E.length&&t;$.createTab=n?function(){M(true,E[1].bind(e))}:E[0].bind(null,e,t);$.createTab.useTab=n?0:1};Settings.updateHooks.showActionIcon=function(e){p=e&&!!chrome.browserAction};chrome.runtime.onMessageExternal&&(chrome.runtime.onMessageExternal.addListener(function(e,t,n){var r;if(d(t.id)){if("string"!=typeof e){if("object"==typeof e)switch(e.handler){case"command":if((r=e.command?e.command+"":"")&&CommandsData.availableCommands[r]){var i,s=(i=t.tab)?b[i.id]:null,o=s?T(i.id,t.frameId||0)||s[0]:null;return R(r,e.options,e.count,o,e.key)}return;case"content_scripts":n(Settings.CONST.ContentScripts);return}}else if((r=e)&&CommandsData.availableCommands[r]){var i,a=(i=t.tab)?b[i.id]:null,o=a?T(i.id,t.frameId||0)||a[0]:null;return R(r,null,1,o)}}else n(false)}),Settings.postUpdate("extWhiteList"));chrome.tabs.onReplaced&&chrome.tabs.onReplaced.addListener(function(e,t){var n=b,r=n[t];if(r){delete n[t];for(var i=(n[e]=r).length;0<--i;)r[i].sender.tabId=e}});Settings.postUpdate("bufferToLoad",null);Settings.postUpdate("vomnibarPage");(function(){var e,t=$;for(var n in t)t[n].useTab=0;for(var r=0,i=e=["goTab","moveTab","reloadTab","removeRightTab","removeTab","removeTabsR","togglePinTab","visitPreviousTab"];r<i.length;r++){var s;t[s=i[r]].useTab=2}for(var o=0,a=e=["copyTabInfo","goToRoot","moveTabToNextWindow","reopenTab","toggleCS","toggleViewSource","searchInAnother"];o<a.length;o++){var s;t[s=a[o]].useTab=1}})();Settings.postUpdate("searchUrl",null);window.onunload=function(e){if(!e||false!==e.isTrusted){var t=b;t.omni=J.framesForOmni;for(var n in t)for(var r=t[n],i=r.length,s=1;s<i;s++)r[s].disconnect()}}})();