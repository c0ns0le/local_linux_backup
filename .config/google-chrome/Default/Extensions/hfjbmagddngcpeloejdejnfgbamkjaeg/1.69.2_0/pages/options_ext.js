"use strict";function formatDate(e){return new Date(+e-6e4*(new Date).getTimezoneOffset()).toJSON().substring(0,19).replace("T"," ")}function cleanRes(){if(_lastBlobURL){URL.revokeObjectURL(_lastBlobURL);_lastBlobURL=""}}function _importSettings(e,t,n){var i=t.environment,o=i&&i.platform||"",r=i&&parseFloat(i.extension||0)||0,l=r>parseFloat(bgSettings.CONST.CurrentVersion);o&&(o=(""+o).substring(0,10));if(confirm("You are loading "+(true!==n?"a settings copy":"the recommended settings:")+"\n      * from "+(1<r?"version "+r+" of ":"")+"Vimium C"+(l?" (newer)":"")+"\n      * for "+(o?"the "+(o[0].toUpperCase()+o.substring(1))+" platform":"common platforms")+"\n      * exported "+(e?"at "+formatDate(e):"before")+"\n\nAre you sure you want to continue?")){Object.setPrototypeOf(t,null);if(null==t.vimSync&&bgSettings.get("vimSync")&&confirm("Do you want to keep settings synchronized with your current Google account?")){t.vimSync=bgSettings.get("vimSync");console.log("You chose to keep settings synced.")}var s=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=n.pop();o="string"!=typeof o||o.length<=72?o:o.substring(0,71).trimRight()+"\u2026";return console.log.apply(console,["%s %c%s",e,"color:darkred",t].concat(n,[o]))};1e4<e?console.info("IMPORT settings saved at %c%s%c.","color:darkblue",formatDate(e),"color:auto"):console.info("IMPORT settings:",n?"recommended":"saved before");delete t.name;delete t.time;delete t.environment;delete t.author;delete t.description;for(var a=localStorage,c=bgSettings.defaults,u=Option.all,f=/\r\n?/g,m=a.length;0<=--m;){var g;0<=(g=a.key(m)).indexOf("|")||(g in t||(t[g]=null))}delete t.findModeRawQuery;delete t.findModeRawQueryList;delete t.innerCSS;delete t.newTabUrl_f;if(null!==t.vimSync&&t.vimSync!==bgSettings.get("vimSync")){s("import","vimSync",t.vimSync);bgSettings.set("vimSync",t.vimSync);u.vimSync.fetch()}for(var d in u){var p=u[d],g,v=t[g=p.field];delete t[g];if(null==v)v=c[g];else{if("string"==typeof c[g]){v instanceof Array&&(v=v.join("\n").trimRight());v=v.replace(f,"\n")}v=p.normalize(v,"object"==typeof c[g])}if(p.areEqual(bgSettings.get(g),v)){if(p.saved)continue}else{s("import",g,v);bgSettings.set(g,v);g in bgSettings.bufferToLoad&&Option.syncToFrontend.push(g)}p.fetch()}for(var g in t){var v;if(null!=(v=t[g])){if("string"==typeof c[g]){v instanceof Array&&(v=v.join("\n").trimRight());v=v.replace(f,"\n")}if(g in c){if(bgSettings.get(g)!==v){bgSettings.set(g,v);s("update",g,v)}}else{a.setItem(g,v);s("save",g,v)}}else{if(g in c){v=c[g];if(bgSettings.get(g)!==v){bgSettings.set(g,v);s("reset",g,v);continue}v=bgSettings.get(g)}else v=a.getItem(g);a.removeItem(g);s("remove",g,":=",v)}}$("#saveOptions").onclick(false);$("#advancedOptionsButton").getAttribute("aria-checked")!=""+bgSettings.get("showAdvancedOptions")&&$("#advancedOptionsButton").onclick(null,true);console.info("IMPORT settings: finished.");var S=VDom.UI.root&&VDom.UI.root.querySelector("#HClose");if(S){S.click();$("#showCommands").click()}if(window.VHUD)return VHUD.showForDuration("Import settings data: OK!",1e3)}else window.VHUD&&VHUD.showForDuration("You cancelled importing.",1e3)}function importSettings(e,t,n){var i=null,o=null,r="";try{var l=parseJSON(t);l instanceof Error?o=l:l?i=l:r="No JSON data found!"}catch(e){o=e}if(null!=o){var s=/^(\d+):(\d+)$/.exec(r=o?o.message+"":"Error: "+(""!==o?o:"(unknown)"));r=s?"Sorry, Vimium C can not parse the JSON file:\n  an unexpect character at line "+s[1]+", column "+s[2]:r}if(i){e=+new Date(i&&i.time||("object"==typeof e?+e:e))||0;if("Vimium C"!==i.name&&"Vimium++"!==i.name||e<1e4&&0<e){r="Sorry, no Vimium C settings data found!";i=null}}if(r)return alert(r);var a=Option.all.keyMappings.checker?1:new Promise(function(e){var t;loadJS("options_checker.js").onload=function(){e(1)}});Promise.all([BG.Utils.require("Commands"),BG.Utils.require("Exclusions"),a]).then(function(){setTimeout(_importSettings,17,e,i,n)})}function parseJSON(e){function t(){return/a?/.test("")}function n(e){if(" ".repeat)return" ".repeat(e.length);for(var t="",n=e.length;0<n--;)t+=" ";return t}function i(e){var t=e[0];return"/"===t||"#"===t?"/*"===e[0]?e.replace(o,n):n(e):e}var o=/[^\r\n]+/g,r=/\b(?:position (\d+)|line (\d+) column (\d+))/,l=/"(?:\\[\\\"]|[^"])*"|'(?:\\[\\\']|[^'])*'|\/\/[^\r\n]*|\/\*.*?\*\//g,s,a,c;if(!e||!(e=e.trimRight()))return null;try{var u=JSON.parse(e.replace(l,i));t();return u}catch(e){s=r.exec(e+"");t();if(!s||!s[0])throw e}if(s[2]){a=+s[2];c=+s[3]}else if(0<+s[1]){var f=e.indexOf("\r")<0?"\n":e.indexOf("\r\n")<0?"\r\n":"\r",m=e.substring(0,+s[1]).split(f);c=m[(a=m.length)-1].length+1}else a=c=1;return new SyntaxError(a+":"+c)}$("#showCommands").onclick=function(e){if(window.VDom){var t,n=VDom.UI.root;e&&e.preventDefault();if(n){if(t=n.querySelector("#HClose")){var i=null!=n.querySelector(".HelpCommandName");click(t);if(i)return}}else;VPort.post({handler:"initHelp",unbound:true,names:true,title:"Command Listing"});e||setTimeout(function(){var e=VDom.UI.root&&VDom.UI.root.querySelector("#HelpDialog");e&&e.querySelector("#HClose").addEventListener("click",function(){window.location.hash=""})},100)}};ExclusionRulesOption.prototype.sortRules=function(e){if(!e||!e.timer){for(var t=this.readValueFromElement(),n=/^([:^]?[a-z\-?*]+:\/\/)?([^\/]+)(\/.*)?/,i,o,r=0,l=t;r<l.length;r++){var s=l[r];if((o=n.exec(i=s.pattern))&&o[1]&&o[2]){i=o[3]||"";(o=o[2].split(".")).reverse();i=o.join(".")+i}s.key=i}t.sort(function(e,t){return e.key<t.key?-1:e.key===t.key?0:1});this.populateElement(t);if(e){e.timer=setTimeout(function(e,t){e.firstChild.data=t,e.timer=0},1e3,e,e.firstChild.data);e.firstChild.data="(Sorted)"}}};$("#exclusionSortButton").onclick=function(){return Option.all.exclusionRules.sortRules(this)};var _lastBlobURL="";$("#exportButton").onclick=function(e){cleanRes();var t,n=!!e&&(e.ctrlKey||e.metaKey||e.shiftKey);(t=Object.create(null)).name="Vimium C";n||(t.time=0);t.environment={chrome:bgSettings.CONST.ChromeVersion,extension:bgSettings.CONST.CurrentVersion,platform:bgSettings.CONST.Platform};for(var i=localStorage,o=bgSettings.defaults,r=0,l=i.length,s=void 0;r<l;r++){var a=i.key(r);if(!(0<=a.indexOf("|")||"_f"===a.substring(a.length-2)||"findModeRawQueryList"===a||"innerCSS"===a)){var c=i.getItem(a);if("string"!=typeof o[a])t[a]=a in o?bgSettings.get(a):c;else if(0<c.indexOf("\n")){t[a]=s=c.split("\n");s.push("")}else t[a]=c}}var u=new Date;n||(t.time=u.getTime());var f=JSON.stringify(t,null,"\t"),m=formatDate(u);"win"===t.environment.platform&&(f=f.replace(/\n/g,"\r\n"));t=null;var g="vimium-c_";g+=n?"settings":m.replace(/[\-:]/g,"").replace(" ","_");g+=".json";var d=document.createElement("a");d.download=g;d.href=URL.createObjectURL(new Blob([f],{type:"application/json",endings:"native"}));_lastBlobURL=d.href;click(d);console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",g,"color:auto","color:darkblue",m,"color:auto")};var _el=$("#settingsFile");_el.onclick=null;_el.onchange=function(){var e=this.files[0];this.value="";if(e){var t=new FileReader,n=e.lastModified||e.lastModifiedDate||0;t.onload=function(){var e;return importSettings(n,this.result,false)};t.readAsText(e)}};(_el=$("#importOptions")).onclick=null;_el.onchange=function(){$("#importButton").focus();if("exported"!==this.value){var e=new XMLHttpRequest;e.open("GET","../settings_template.json",true);e.responseType="text";e.onload=function(){return importSettings(0,this.responseText,true)};e.send()}else click($("#settingsFile"))};_el=null;window._delayed&&(function(){var e=window._delayed;delete window._delayed;var t=$(e[0]),n;t.onclick&&t.onclick(e[1]);BG.Utils.GC()})();